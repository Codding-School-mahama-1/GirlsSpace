<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GBV Prevention & Response | GirlsSpace</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Playfair+Display:ital,wght@0,600;0,800;1,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f9f7fd; }
    .font-serif { font-family: 'Playfair Display', serif; }

            .nav-link::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -4px;
      left: 50%;
      background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
      transition: all 0.3s ease;
      transform: translateX(-50%);
    }
    .nav-link:hover::after {
      width: 100%;
    }
    
    .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(6px, 6px); }
    .hamburger.active span:nth-child(2) { opacity: 0; }
    .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
    
    .gradient-btn { background: linear-gradient(90deg, #ff5f8d, #c23cb6); transition: all 0.3s ease; }
    .gradient-btn:hover { box-shadow: 0 12px 30px rgba(194, 59, 182, 0.4); transform: translateY(-3px); }
    .gradient-btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
    
    .progress-bar { height: 12px; background: #e2e8f0; border-radius: 999px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #ff5f8d, #c23cb6); width: 0%; transition: width 0.9s ease; }
    
    .module-locked { opacity: 0.6; pointer-events: none; filter: grayscale(100%); }

    .quiz-card {
      background: white;
      border-radius: 24px;
      box-shadow: 0 12px 35px rgba(0,0,0,0.1);
      transition: all 0.4s ease;
      border: 3px solid transparent;
    }
    .quiz-card:hover { border-color: #ff5f8d; }
    .quiz-option {
      background: #fdfafb;
      border: 2px solid #f0e6f6;
      border-radius: 18px;
      padding: 18px 22px;
      margin: 12px 0;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .quiz-option:hover { background: #fdf2f8; border-color: #ff5f8d; }
    .correct { background: #d4edda !important; border-color: #28a745 !important; }
    .wrong { background: #f8d7da !important; border-color: #dc3545 !important; }

    /* Certificate Styles */
    .certificate-border {
      border: 10px solid transparent;
      border-image: linear-gradient(to right, #c23cb6, #ff5f8d) 1;
      background: white;
    }
    .certificate-bg-pattern {
      background-image: radial-gradient(#f3e8f5 2px, transparent 2px);
      background-size: 30px 30px;
    }

    /* Video Overlay */
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 1rem; background: black; }
    .video-container iframe, .video-container .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .video-container .overlay {
        background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.6)), url('https://img.freepik.com/free-vector/flat-design-purple-wavyle-background_23-2149105265.jpg');
        background-size: cover;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
    }
    .video-container .overlay:hover .play-icon { transform: scale(1.1); }

    .modal-enter { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body class="bg-purple-50 text-gray-800">
    <nav class="flex items-center justify-between px-5 py-3 bg-white sticky top-0 z-5000 shadow-nav md:px-10">
    
    <div class="w-[60px] h-[50px]">
      <img src="./img/Girls Space (1) (1).png" alt="GirlsSpace Logo" class="w-full h-full object-contain rounded-full">
    </div>

    <div class="flex flex-col gap-[5px] cursor-pointer z-[1001] md:hidden hamburger" onclick="toggleMenu()">
      <span class="w-7 h-[3px] bg-gray-700 rounded transition-all duration-300"></span>
      <span class="w-7 h-[3px] bg-gray-700 rounded transition-all duration-300"></span>
      <span class="w-7 h-[3px] bg-gray-700 rounded transition-all duration-300"></span>
    </div>

    <ul class="nav-links fixed top-0 left-[-100%] w-[280px] h-screen bg-white flex flex-col pt-20 gap-5 shadow-md transition-all duration-300 z-[1000] md:static md:flex-row md:w-auto md:h-auto md:p-0 md:shadow-none md:bg-transparent overflow-y-auto md:overflow-visible">
      
      <li><a href="./index.html" class="nav-link relative text-gray-text font-medium text-base md:text-sm hover:text-pink-primary transition-colors block w-full text-center py-2 md:py-0 md:w-auto border-b border-gray-100 md:border-none">Home</a></li>
      <li><a href="./AboutUs.html" class="nav-link relative text-gray-text font-medium text-base md:text-sm hover:text-pink-primary transition-colors block w-full text-center py-2 md:py-0 md:w-auto border-b border-gray-100 md:border-none">About</a></li>
      <li><a href="./chat.html" class="nav-link relative text-gray-text font-medium text-base md:text-sm hover:text-pink-primary transition-colors block w-full text-center py-2 md:py-0 md:w-auto border-b border-gray-100 md:border-none">Chat</a></li>
      <li><a href="./stories.html" class="nav-link relative text-gray-text font-medium text-base md:text-sm hover:text-pink-primary transition-colors block w-full text-center py-2 md:py-0 md:w-auto border-b border-gray-100 md:border-none">Stories</a></li>
      <li><a href="./Learning_Programs.html" class="nav-link relative text-gray-text font-medium text-base md:text-sm hover:text-pink-primary transition-colors block w-full text-center py-2 md:py-0 md:w-auto border-b border-gray-100 md:border-none">Programs</a></li>
      <li><a href="./protection.html" class="nav-link relative text-gray-text font-medium text-base md:text-sm hover:text-pink-primary transition-colors block w-full text-center py-2 md:py-0 md:w-auto border-b border-gray-100 md:border-none">Protection</a></li>

      <li class="relative group w-full md:w-auto text-center">
        <a href="#" class="nav-link relative text-gray-text font-medium text-base md:text-sm hover:text-pink-primary transition-colors block py-2 md:py-0 border-b border-gray-100 md:border-none">Languages</a>
        <ul class="absolute top-full left-0 bg-white shadow-lg rounded-lg min-w-[130px] hidden group-hover:block z-50 py-2">
          <li><a href="#" class="block px-4 py-2 text-sm text-gray-text hover:bg-purple-light hover:text-purple-btn">English</a></li>
          <li><a href="#" class="block px-4 py-2 text-sm text-gray-text hover:bg-purple-light hover:text-purple-btn">Arabic</a></li>
          <li><a href="#" class="block px-4 py-2 text-sm text-gray-text hover:bg-purple-light hover:text-purple-btn">Swahili</a></li>
          <li><a href="#" class="block px-4 py-2 text-sm text-gray-text hover:bg-purple-light hover:text-purple-btn">French</a></li>
          <li><a href="#" class="block px-4 py-2 text-sm text-gray-text hover:bg-purple-light hover:text-purple-btn">Kinyarwanda</a></li>
        </ul>
      </li>

      <li class="w-full md:w-auto text-center mt-2 md:mt-0">
        <a href="./login.html" class="inline-block px-4 py-1.5 border-[1.5px] border-purple-btn text-purple-btn rounded-full font-semibold text-[13px] hover:bg-purple-light transition-colors">Log In</a>
      </li>
      <li class="w-full md:w-auto text-center mb-4 md:mb-0">
        <a href="./Donate.html" class="inline-block px-4 py-2 bg-gradient-to-r from-gradient-start to-purple-btn text-black rounded-full font-semibold text-[13px] hover:border hover:border-purple-btn hover:shadow-glow transition-all">Donate</a>
      </li>
    </ul>

    <div class="mt-2 w-full md:mt-0 md:w-auto order-3 md:order-none">
      <input type="text" placeholder="Search..." class="w-full md:w-[160px] px-3 py-1.5 rounded-[10px] border border-gray-200 outline-none text-[13px] focus:border-pink-primary">
    </div>

  </nav>

  <div class="nav-overlay fixed inset-0 bg-black/50 hidden z-[999]" onclick="closeMenu()"></div>

  <nav class="sticky top-0 z-50 bg-white shadow-xl flex flex-wrap items-center justify-between px-5 py-4 md:px-10">

    <div class="hamburger cursor-pointer space-y-1.5 md:hidden z-50">
      <span class="block w-8 h-1 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full transition-all duration-300"></span>
      <span class="block w-8 h-1 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full transition-all duration-300"></span>
      <span class="block w-8 h-1 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full transition-all duration-300"></span>
    </div>
    <ul class="nav-links fixed top-0 -left-full w-80 h-full bg-white/98 backdrop-blur-lg flex flex-col p-6 pt-24 gap-8 transition-all duration-500 md:static md:flex-row md:w-auto md:h-auto md:p-0 md:gap-8 md:items-center z-40 shadow-2xl md:shadow-none border-r md:border-none border-purple-100">
      <li id="auth-section" class="md:border-l md:border-gray-200 md:pl-6 flex items-center gap-4">
        <button onclick="openLoginModal()" class="text-purple-700 font-bold hover:text-pink-600 flex items-center gap-2">
          <i class="fas fa-user-circle text-2xl"></i> <span>Login</span>
        </button>
      </li>
    </ul>
  </nav>
  <div class="nav-overlay fixed inset-0 bg-black/70 hidden z-30"></div>

  <header class="bg-gradient-to-br from-pink-600 via-purple-600 to-indigo-700 text-white py-20 text-center">
    <div class="max-w-6xl mx-auto px-6">
      <h1 class="text-4xl md:text-6xl font-extrabold mb-6 leading-tight">Prevention & Response to <br/> Gender-Based Violence</h1>
      <p class="text-xl md:text-2xl opacity-95 max-w-3xl mx-auto">Learn how to protect yourself and others.</p>
    </div>
  </header>

  <div class="container max-w-7xl mx-auto px-6 py-12">
    <div class="mb-12 bg-white rounded-3xl shadow-2xl p-8 border border-purple-100">
      <div class="flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="text-center md:text-left">
          <h2 class="text-3xl font-bold text-purple-700">Your Progress</h2>
          <p class="text-gray-500 mt-2" id="user-greeting">Guest User</p>
        </div>
        <span id="progress-text" class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600">0%</span>
      </div>
      <div class="progress-bar mt-6"><div id="progress-fill" class="progress-fill"></div></div>
    </div>

    <div id="modules-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></div>

    <div id="completion-section" class="hidden mt-20 text-center space-y-8 animate-bounce-in">
        <div class="p-10 bg-gradient-to-r from-pink-100 to-purple-100 rounded-3xl border-4 border-white shadow-2xl">
            <h2 class="text-4xl font-extrabold text-purple-800 mb-4">Course Completed! ðŸŒŸ</h2>
            <p class="text-xl text-gray-600 mb-8">You have passed all modules.</p>
            <button onclick="showCertificate()" class="gradient-btn text-white px-12 py-6 rounded-full text-2xl font-bold shadow-2xl hover:scale-105 transition-transform">
                <i class="fas fa-certificate mr-3"></i> Get Certificate
            </button>
        </div>
    </div>
  </div>

  <div id="login-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden modal-enter relative">
      <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-2xl"><i class="fas fa-times"></i></button>
      <div class="p-8 text-center">
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Welcome!</h3>
        <form id="login-form" class="space-y-4 text-left mt-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
            <input type="text" id="username-input" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-purple-500 outline-none" placeholder="Jane Doe">
          </div>
          <button type="submit" class="w-full gradient-btn text-white py-3 rounded-xl font-bold text-lg shadow-md">Login / Sign Up</button>
        </form>
      </div>
    </div>
  </div>

  <div id="certificate-modal" class="fixed inset-0 bg-black/90 z-[200] hidden flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white w-full max-w-4xl shadow-2xl relative modal-enter flex flex-col">
      <button onclick="document.getElementById('certificate-modal').classList.add('hidden')" class="absolute top-4 right-4 bg-gray-200 rounded-full w-10 h-10 z-10 hover:bg-red-100 hover:text-red-500"><i class="fas fa-times"></i></button>
      <div id="certificate-content" class="p-8 md:p-16 text-center certificate-border certificate-bg-pattern relative" style="width: 100%;">
        <i class="fas fa-award text-pink-500 text-4xl absolute top-6 left-6 opacity-50"></i>
        <i class="fas fa-award text-purple-500 text-4xl absolute top-6 right-6 opacity-50"></i>
        <h2 class="text-xl uppercase tracking-[0.3em] text-gray-500 font-semibold mb-4">Certificate of Completion</h2>
        <h1 class="font-serif text-4xl md:text-5xl text-purple-800 font-bold italic mb-4">GirlsSpace Academy</h1>
        <p class="text-lg text-gray-600 my-4">This is to certify that</p>
        <div class="font-serif text-3xl md:text-4xl text-pink-600 border-b-2 border-gray-300 pb-2 px-10 mb-6 inline-block" id="cert-name">Name</div>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto leading-relaxed mb-10">Has successfully completed the program on <br><strong class="text-purple-700">"Prevention and Response to Gender-Based Violence"</strong></p>
        <div class="flex flex-row justify-between w-full px-8 mt-12">
          <div class="text-center"><p class="font-serif text-lg text-gray-800 border-t border-gray-400 pt-2 px-6" id="cert-date">Date</p><span class="text-xs text-gray-500 uppercase tracking-widest">Date</span></div>
          <div class="text-center"><div class="font-serif text-xl text-gray-800 mb-[-5px]" style="font-family: cursive;">GirlsSpace Team</div><p class="text-lg border-t border-gray-400 pt-2 px-6 mt-2"></p><span class="text-xs text-gray-500 uppercase tracking-widest">Signature</span></div>
        </div>
      </div>
      <div class="text-center p-6 bg-gray-50 border-t border-gray-200">
         <button onclick="downloadPDF()" class="gradient-btn text-white px-10 py-3 rounded-full text-lg font-bold shadow-lg"><i class="fas fa-file-pdf mr-2"></i> Download PDF</button>
      </div>
    </div>
  </div>


  <footer class="bg-black text-slate-200 py-12 px-6 font-inter border-t border-slate-800">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
        
        <div class="col-span-1 md:col-span-2">
          <div class="flex items-center gap-3 mb-4">
            <img src="./img/Girls Space (1) (1).png" onerror="this.src='https://via.placeholder.com/50'" alt="Logo" class="w-[50px] h-[50px] object-contain rounded-full border-2 border-[rgb(255,135,219)]">
            <p class="font-semibold text-[rgb(255,135,219)] text-base">Empowering Girls, Building Futures</p>
          </div>
          <p class="text-sm leading-relaxed text-slate-400 max-w-sm mb-6">
            A safe digital haven where girls in Mahama refugee camp can connect, learn, grow, and thrive.
          </p>
          <div class="flex gap-3">
            <a href="#" class="w-10 h-10 bg-slate-800 border border-slate-700 rounded-lg flex items-center justify-center text-slate-300 hover:bg-slate-700 hover:text-white hover:-translate-y-1 transition-all"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="w-10 h-10 bg-slate-800 border border-slate-700 rounded-lg flex items-center justify-center text-slate-300 hover:bg-slate-700 hover:text-white hover:-translate-y-1 transition-all"><i class="fab fa-twitter"></i></a>
            <a href="#" class="w-10 h-10 bg-slate-800 border border-slate-700 rounded-lg flex items-center justify-center text-slate-300 hover:bg-slate-700 hover:text-white hover:-translate-y-1 transition-all"><i class="fab fa-instagram"></i></a>
            <a href="#" class="w-10 h-10 bg-slate-800 border border-slate-700 rounded-lg flex items-center justify-center text-slate-300 hover:bg-slate-700 hover:text-white hover:-translate-y-1 transition-all"><i class="fab fa-youtube"></i></a>
          </div>
        </div>

        <div>
          <h4 class="text-white font-semibold text-lg mb-4">Quick Links</h4>
          <ul class="space-y-3 text-sm text-slate-400">
            <li><a href="#" class="hover:text-[rgb(219,120,228)] transition-colors">Join Chat</a></li>
            <li><a href="#" class="hover:text-[rgb(219,120,228)] transition-colors">Share Story</a></li>
            <li><a href="#" class="hover:text-[rgb(219,120,228)] transition-colors">Programs</a></li>
          </ul>
        </div>

        <div>
          <h4 class="text-white font-semibold text-lg mb-4">Get Help</h4>
          <ul class="space-y-3 text-sm text-slate-400">
            <li><a href="#" class="hover:text-[rgb(219,120,228)] transition-colors">Emergency</a></li>
            <li><a href="#" class="hover:text-[rgb(219,120,228)] transition-colors">Support</a></li>
            <li><a href="#" class="hover:text-[rgb(219,120,228)] transition-colors">Report</a></li>
          </ul>
        </div>
      </div>

      <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 pt-6 border-t border-slate-800 text-sm text-slate-500">
        <div>
          <p>Â© 2025 GirlsSpace Mahama. <span class="text-[rgb(183,64,219)] font-medium">Empowering girls, always.</span></p>
        </div>
        <div class="text-left md:text-right">
          <p class="mb-1">Available in: English, FranÃ§ais, Kiswahili, Kinyarwanda, Arabic</p>
          <p>Supported by UNHCR, Save The Children, Alight</p>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // --- Module Data (Using Video IDs instead of full URLs for API) ---
    const modules = [
      {title: "Introduction to GBV", videoId: "-eVdXMmYC_E"},
      {title: "Types of Violence", videoId: "3AF9Rjki0DE"},
      {title: "Personal Safety Planning", videoId: "AfWHGpwWE1o"},
      {title: "How to Support Survivors", videoId: "MsMlM-xyf5k"},
      {title: "Violence in Refugee Settings", videoId: "wscDqSSJBxI"},
      {title: "Building Safe Spaces", videoId: "kqHBaej2cBA"},
      {title: "Reporting Cases", videoId: "7ijfkDyw6sA"},
      {title: "Community Leadership", videoId: "ZcU6t9z4-3w"},
      {title: "Mental Health & Recovery", videoId: "Wibnx1JEb5U"},
      {title: "Legal Rights of Survivors", videoId: "26u5xHyNFLs"},
      {title: "Youth Role in Prevention", videoId: "ebxkz_BR1zM"},
      {title: "Healing and Moving Forward", videoId: "uxyUxFxdRKc"}
    ];

    const questionBank = [
      {question: "What is one form of gender-based violence?", options: ["Just physical hitting", "Forced Marriage", "Playing with friends", "Studying"], answer: 1},
      {question: "If you experience violence, the first safe step is:", options: ["Silence", "Tell someone you trust", "Fight back immediately", "Forget about it"], answer: 1}
    ];

    let currentModule = 0;
    let currentUser = localStorage.getItem('gs_user_name') || null;
    let players = {}; // Store YouTube players

    // --- Auth Logic ---
    function updateAuthUI() {
      const authSection = document.getElementById('auth-section');
      const greeting = document.getElementById('user-greeting');
      if (currentUser) {
        greeting.textContent = `Welcome back, ${currentUser}`;
        authSection.innerHTML = `<div class="flex items-center gap-3"><span class="font-semibold text-purple-800 hidden md:inline">${currentUser}</span><button onclick="logout()" class="text-sm border border-red-200 px-3 py-1 rounded text-red-500 hover:bg-red-50">Logout</button></div>`;
      } else {
        greeting.textContent = "Guest User (Progress not saved)";
        authSection.innerHTML = `<button onclick="openLoginModal()" class="text-purple-700 font-bold hover:text-pink-600 flex items-center gap-2"><i class="fas fa-user-circle text-2xl"></i> <span>Login</span></button>`;
      }
    }
    function openLoginModal() { document.getElementById('login-modal').classList.remove('hidden'); }
    function closeLoginModal() { document.getElementById('login-modal').classList.add('hidden'); }
    document.getElementById('login-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('username-input').value;
      if(name) { currentUser = name; localStorage.setItem('gs_user_name', name); updateAuthUI(); closeLoginModal(); renderModules(); }
    });
    function logout() { if(confirm("Logout?")) { localStorage.removeItem('gs_user_name'); currentUser = null; window.location.reload(); } }

    // --- Helper Functions ---
    function getStorageKey(index, type = 'quiz') {
        const userSuffix = currentUser ? `_${currentUser}` : '';
        return `gbv-${type}-${index}${userSuffix}`;
    }

    // --- Main Render Logic ---
    function renderModules() {
      const container = document.getElementById('modules-container');
      container.innerHTML = '';
      let allPassed = true;

      modules.forEach((mod, i) => {
        const prevQuizKey = getStorageKey(i-1, 'quiz');
        const thisQuizKey = getStorageKey(i, 'quiz');
        const thisWatchedKey = getStorageKey(i, 'watched');

        const prevPassed = i === 0 || localStorage.getItem(prevQuizKey) === 'true';
        const thisPassed = localStorage.getItem(thisQuizKey) === 'true';
        const hasWatched = localStorage.getItem(thisWatchedKey) === 'true';
        
        const isModuleLocked = i > 0 && !prevPassed;
        if (!thisPassed) allPassed = false;

        container.innerHTML += `
          <div class="bg-white rounded-3xl shadow-xl overflow-hidden ${isModuleLocked ? 'module-locked' : ''} transition-all hover:-translate-y-4 flex flex-col h-full">
            <div class="bg-gradient-to-r from-pink-500 to-purple-600 text-white p-6 flex justify-between items-center">
              <h3 class="text-xl font-bold">Module ${i+1}</h3>
              ${thisPassed ? '<i class="fas fa-check-circle text-3xl text-green-300"></i>' : '<i class="fas fa-play-circle text-3xl"></i>'}
            </div>
            
            <div class="p-8 flex-1 flex flex-col">
              <h4 class="text-xl font-bold text-purple-700 mb-5 flex-1">${mod.title}</h4>
              
              <div class="video-container mb-6 shadow-lg rounded-2xl overflow-hidden">
                 ${hasWatched ? 
                    // If watched, show iframe directly or a placeholder saying watched
                    `<iframe src="https://www.youtube.com/embed/${mod.videoId}" allowfullscreen></iframe>` :
                    // If NOT watched, show clickable overlay to init API
                    `<div id="player-wrapper-${i}" class="w-full h-full">
                        <div class="overlay" onclick="initPlayer(${i}, '${mod.videoId}')">
                            <div class="play-icon w-16 h-16 bg-pink-600 rounded-full flex items-center justify-center shadow-lg text-white transition-transform duration-300">
                                <i class="fas fa-play text-2xl ml-1"></i>
                            </div>
                        </div>
                        <div id="yt-player-${i}"></div>
                     </div>`
                 }
              </div>

              <div id="action-area-${i}">
                  ${thisPassed ? 
                    `<button onclick="startQuiz(${i})" class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-lg">Completed (Retake)</button>` :
                    (hasWatched ? 
                        `<button onclick="startQuiz(${i})" class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-lg animate-pulse">Start Quiz (2 Qs)</button>` :
                        `<div class="text-center p-3 bg-gray-100 rounded-xl text-gray-500 font-medium text-sm">
                            <i class="fas fa-eye mr-2"></i> Watch full video to unlock quiz
                         </div>`
                    )
                  }
              </div>
            </div>
          </div>`;
      });

      updateProgress();
      updateAuthUI();

      if (allPassed) document.getElementById('completion-section').classList.remove('hidden');
      else document.getElementById('completion-section').classList.add('hidden');
    }

    // --- YouTube API Logic ---
    // This function is called when the overlay is clicked
    function initPlayer(index, videoId) {
        // Remove overlay visually
        const wrapper = document.getElementById(`player-wrapper-${index}`);
        wrapper.querySelector('.overlay').style.display = 'none';

        // Create Player
        players[index] = new YT.Player(`yt-player-${index}`, {
            height: '100%',
            width: '100%',
            videoId: videoId,
            playerVars: { 'autoplay': 1, 'rel': 0 },
            events: {
                'onStateChange': (event) => onPlayerStateChange(event, index)
            }
        });
    }

    // Called when video state changes (Playing, Paused, Ended)
    function onPlayerStateChange(event, index) {
        // YT.PlayerState.ENDED is 0
        if (event.data === YT.PlayerState.ENDED) {
            unlockQuiz(index);
        }
    }

    function unlockQuiz(index) {
        localStorage.setItem(getStorageKey(index, 'watched'), 'true');
        const actionArea = document.getElementById(`action-area-${index}`);
        
        // Update UI immediately to show Quiz Button
        actionArea.innerHTML = `
            <div class="text-center mb-2 text-green-600 font-bold animate-bounce">Video Completed!</div>
            <button onclick="startQuiz(${index})" class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-lg shadow-xl">
                Start Quiz (2 Qs)
            </button>
        `;
    }

    // --- Quiz & Logic ---
    function startQuiz(index) {
        currentModule = index;
        const shuffled = [...questionBank].sort(() => Math.random() - 0.5).slice(0, 2);
        document.body.insertAdjacentHTML('beforeend', `
            <div id="quiz-modal" class="fixed inset-0 bg-black/85 z-[60] flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl max-w-4xl w-full p-10 relative">
                <button onclick="document.getElementById('quiz-modal').remove()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                <h2 class="text-3xl font-bold text-center text-purple-700 mb-8">Module ${index+1} Quiz</h2>
                <div class="grid md:grid-cols-2 gap-6" id="quiz-questions"></div>
                <button onclick="submitQuiz()" class="w-full gradient-btn text-white py-4 rounded-xl mt-8 font-bold text-xl">Submit</button>
            </div></div>
        `);
        const container = document.getElementById('quiz-questions');
        shuffled.forEach((q, i) => {
            container.innerHTML += `<div class="quiz-card p-6 border border-gray-100 bg-purple-50 rounded-xl"><p class="font-bold mb-4">${i+1}. ${q.question}</p><div class="space-y-2">${q.options.map((o,j)=>`<label class="flex items-center gap-3 p-3 bg-white rounded-lg border cursor-pointer hover:border-pink-500"><input type="radio" name="q${i}" value="${j}" class="text-pink-600"><span>${o}</span></label>`).join('')}</div></div>`;
        });
    }

    function submitQuiz() {
        const answers = document.querySelectorAll('#quiz-modal input:checked');
        if (answers.length < 2) return alert("Answer all questions");
        let correct = 0;
        answers.forEach(a => {
             const qText = a.closest('.quiz-card').querySelector('p').textContent.split('. ')[1];
             if(parseInt(a.value) === questionBank.find(q=>q.question===qText).answer) correct++;
        });
        
        if(correct >= 1) {
            localStorage.setItem(getStorageKey(currentModule, 'quiz'), 'true');
            alert("Passed!");
            document.getElementById('quiz-modal').remove();
            renderModules();
        } else {
            alert("Try again.");
        }
    }

    function updateProgress() {
      const done = modules.filter((_,i) => localStorage.getItem(getStorageKey(i, 'quiz'))).length;
      const perc = Math.round((done / modules.length) * 100);
      document.getElementById('progress-fill').style.width = perc + '%';
      document.getElementById('progress-text').textContent = perc + '%';
    }

    // --- Certificate ---
    function showCertificate() {
      document.getElementById('cert-name').textContent = currentUser || "Student";
      document.getElementById('cert-date').textContent = new Date().toLocaleDateString();
      document.getElementById('certificate-modal').classList.remove('hidden');
    }
    function downloadPDF() {
        const btn = document.querySelector('#certificate-modal button.gradient-btn');
        btn.innerHTML = 'Generating...';
        html2pdf().set({ margin: 0.5, filename: 'Certificate.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' } }).from(document.getElementById('certificate-content')).save().then(() => btn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i> Download PDF');
    }

    document.querySelector('.hamburger').addEventListener('click', () => { document.querySelector('.nav-links').classList.toggle('-left-full'); document.querySelector('.nav-links').classList.toggle('left-0'); document.querySelector('.nav-overlay').classList.toggle('hidden'); });
    document.querySelector('.nav-overlay').addEventListener('click', () => { document.querySelector('.nav-links').classList.add('-left-full'); document.querySelector('.nav-overlay').classList.add('hidden'); });

    window.onload = renderModules;
  </script>
</body>
</html>