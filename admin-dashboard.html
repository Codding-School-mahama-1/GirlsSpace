<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Admin Dashboard - GirlsSpace Mahama</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@400;500;600;700;900&display=swap" rel="stylesheet">
 
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            poppins: ['Poppins', 'sans-serif'],
            inter: ['Inter', 'sans-serif'],
          },
          colors: {
            primary: '#ec4899',
            'primary-dark': '#be185d',
            accent: '#fbbf24',
            dark: '#0f0f14',
            'custom-purple': '#c23cb6',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#3b82f6',
          },
          animation: {
            float: 'float 3s ease-in-out infinite',
            'spin-slow': 'spin 10s linear infinite',
            pulse: 'pulse-glow 2s ease-in-out infinite',
            fadeIn: 'fadeIn 0.5s ease-in-out',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-12px)' },
            },
            'pulse-glow': {
              '0%, 100%': { boxShadow: '0 10px 30px rgba(236,72,154,0.2)' },
              '50%': { boxShadow: '0 15px 40px rgba(236,72,154,0.4)' },
            },
            fadeIn: {
              '0%': { opacity: 0, transform: 'translateY(-10px)' },
              '100%': { opacity: 1, transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #c23cb6; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #ec4899; }
    .smooth-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .dashboard-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-active { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .status-pending { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .status-inactive { background: rgba(107, 114, 128, 0.1); color: #6b7280; }
    .status-warning { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .sidebar-link.active { background: linear-gradient(90deg, rgba(236, 72, 153, 0.1) 0%, rgba(236, 72, 153, 0.05) 100%); border-left: 4px solid #ec4899; color: #ec4899; }
    .table-row:hover { background: rgba(236, 72, 153, 0.05); }
   
    /* Toast notification styles */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    .toast.show {
      transform: translateX(0);
    }
    .toast.success {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    .toast.error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    .toast.warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    .toast.info {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }
   
    /* Loading spinner */
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ec4899;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Modal styles */
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
    }

    /* Settings specific styles */
    .settings-tab {
      transition: all 0.2s ease;
      margin-bottom: -1px;
    }

    .settings-content {
      animation: fadeIn 0.3s ease-in-out;
    }

    .settings-content.active {
      display: block;
    }

    /* Range input styling */
    input[type="range"] {
      -webkit-appearance: none;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #ec4899;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Toggle switch styling */
    .toggle-checkbox:checked {
      right: 0;
      border-color: #ec4899;
    }

    .toggle-checkbox:checked + .toggle-label {
      background-color: #ec4899;
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-gray-800 min-h-screen">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-lg">
      <!-- Logo -->
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-r from-primary to-custom-purple rounded-full flex items-center justify-center">
            <i class="fas fa-shield-alt text-white"></i>
          </div>
          <div>
            <h2 class="font-bold text-lg text-gray-800">GirlsSpace Admin</h2>
            <p class="text-xs text-gray-500">Administrator Panel</p>
          </div>
        </div>
      </div>
     
      <!-- Admin Profile -->
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center space-x-3">
          <div class="relative">
            <img src="https://ui-avatars.com/api/?name=Admin&background=c23cb6&color=fff" alt="Admin" class="w-12 h-12 rounded-full border-2 border-primary">
            <span class="absolute bottom-0 right-0 w-3 h-3 bg-success rounded-full border-2 border-white"></span>
          </div>
          <div class="flex-1 min-w-0">
            <p id="admin-name" class="font-semibold text-gray-800 truncate">Loading...</p>
            <p id="admin-email" class="text-sm text-gray-500 truncate">Loading...</p>
          </div>
        </div>
      </div>
     
      <!-- Navigation -->
      <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
        <a href="#dashboard" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:text-primary hover:bg-pink-50 smooth-transition active">
          <i class="fas fa-chart-bar text-lg w-6"></i>
          <span class="font-medium">Dashboard</span>
        </a>
        <a href="#users" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:text-primary hover:bg-pink-50 smooth-transition">
          <i class="fas fa-users text-lg w-6"></i>
          <span class="font-medium">Users</span>
          <span id="sidebar-total-users" class="ml-auto bg-primary text-white text-xs px-2 py-1 rounded-full">0</span>
        </a>
        <a href="#stories" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:text-primary hover:bg-pink-50 smooth-transition">
          <i class="fas fa-book-open text-lg w-6"></i>
          <span class="font-medium">Stories</span>
          <span id="sidebar-pending-stories" class="ml-auto bg-warning text-white text-xs px-2 py-1 rounded-full">0</span>
        </a>
        <a href="#content" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:text-primary hover:bg-pink-50 smooth-transition">
          <i class="fas fa-newspaper text-lg w-6"></i>
          <span class="font-medium">Content</span>
        </a>
        <a href="#chat" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:text-primary hover:bg-pink-50 smooth-transition">
          <i class="fas fa-comments text-lg w-6"></i>
          <span class="font-medium">Chat Rooms</span>
        </a>
        <a href="#reports" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:text-primary hover:bg-pink-50 smooth-transition">
          <i class="fas fa-flag text-lg w-6"></i>
          <span class="font-medium">Reports</span>
          <span id="sidebar-pending-reports" class="ml-auto bg-danger text-white text-xs px-2 py-1 rounded-full">0</span>
        </a>
        <a href="#analytics" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:text-primary hover:bg-pink-50 smooth-transition">
          <i class="fas fa-chart-pie text-lg w-6"></i>
          <span class="font-medium">Analytics</span>
        </a>
        <a href="#settings" class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:text-primary hover:bg-pink-50 smooth-transition">
          <i class="fas fa-cog text-lg w-6"></i>
          <span class="font-medium">Settings</span>
        </a>
      </nav>
     
      <!-- Logout -->
      <div class="p-4 border-t border-gray-200">
        <button onclick="logout()" class="flex items-center space-x-3 p-3 w-full text-left rounded-lg text-gray-600 hover:text-danger hover:bg-red-50 smooth-transition">
          <i class="fas fa-sign-out-alt text-lg w-6"></i>
          <span class="font-medium">Log Out</span>
        </button>
      </div>
    </div>
 
    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Top Bar -->
      <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold text-gray-800">Dashboard Overview</h1>
            <div class="hidden md:flex items-center space-x-2 text-sm text-gray-500">
              <i class="fas fa-calendar-alt"></i>
              <span id="current-date">Loading...</span>
            </div>
          </div>

          <div class="flex items-center space-x-4">
            <!-- Notifications -->
            <div class="relative">
              <button id="notification-btn" class="p-2 rounded-full hover:bg-gray-100 smooth-transition">
                <i class="fas fa-bell text-xl text-gray-600"></i>
                <span class="absolute top-1 right-1 w-2 h-2 bg-danger rounded-full"></span>
              </button>
              <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 hidden z-50">
                <div class="p-4 border-b border-gray-200">
                  <h3 class="font-bold text-gray-800">Notifications</h3>
                </div>
                <div id="notifications-list" class="max-h-96 overflow-y-auto">
                  <div class="p-4 text-center text-gray-500">No notifications</div>
                </div>
                <div class="p-4 border-t border-gray-200">
                  <a href="#" class="text-primary text-sm font-medium hover:underline">View all notifications</a>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <button onclick="showAddUserModal()" class="px-4 py-2 bg-gradient-to-r from-primary to-custom-purple text-white rounded-lg font-medium hover:shadow-lg smooth-transition flex items-center space-x-2">
              <i class="fas fa-plus"></i>
              <span>Add New User</span>
            </button>
          </div>
        </div>
      </header>

      <!-- Dashboard Content -->
      <main class="flex-1 overflow-y-auto p-6">
        <!-- Dashboard Section -->
        <div id="dashboard-section">
          <!-- Stats Overview -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="dashboard-card bg-white rounded-xl p-6 shadow border border-gray-100">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <p class="text-sm text-gray-500">Total Users</p>
                  <h3 id="total-users" class="text-2xl font-bold text-gray-800">0</h3>
                </div>
                <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
                  <i class="fas fa-users text-primary text-xl"></i>
                </div>
              </div>
              <div class="flex items-center text-sm">
                <span id="users-change" class="text-success flex items-center">
                  <i class="fas fa-arrow-up mr-1"></i>
                  Loading...
                </span>
                <span class="text-gray-500 ml-2">from last month</span>
              </div>
            </div>

            <div class="dashboard-card bg-white rounded-xl p-6 shadow border border-gray-100">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <p class="text-sm text-gray-500">Active Stories</p>
                  <h3 id="active-stories" class="text-2xl font-bold text-gray-800">0</h3>
                </div>
                <div class="w-12 h-12 bg-success/10 rounded-full flex items-center justify-center">
                  <i class="fas fa-book-open text-success text-xl"></i>
                </div>
              </div>
              <div class="flex items-center text-sm">
                <span id="stories-change" class="text-success flex items-center">
                  <i class="fas fa-arrow-up mr-1"></i>
                  Loading...
                </span>
                <span class="text-gray-500 ml-2">from last week</span>
              </div>
            </div>

            <div class="dashboard-card bg-white rounded-xl p-6 shadow border border-gray-100">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <p class="text-sm text-gray-500">Chat Sessions</p>
                  <h3 id="chat-sessions" class="text-2xl font-bold text-gray-800">156</h3>
                </div>
                <div class="w-12 h-12 bg-info/10 rounded-full flex items-center justify-center">
                  <i class="fas fa-comments text-info text-xl"></i>
                </div>
              </div>
              <div class="flex items-center text-sm">
                <span class="text-success flex items-center">
                  <i class="fas fa-arrow-up mr-1"></i>
                  24.3%
                </span>
                <span class="text-gray-500 ml-2">from yesterday</span>
              </div>
            </div>

            <div class="dashboard-card bg-white rounded-xl p-6 shadow border border-gray-100">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <p class="text-sm text-gray-500">Pending Reports</p>
                  <h3 id="pending-reports" class="text-2xl font-bold text-gray-800">0</h3>
                </div>
                <div class="w-12 h-12 bg-warning/10 rounded-full flex items-center justify-center">
                  <i class="fas fa-flag text-warning text-xl"></i>
                </div>
              </div>
              <div class="flex items-center text-sm">
                <span id="reports-change" class="text-danger flex items-center">
                  <i class="fas fa-arrow-down mr-1"></i>
                  Loading...
                </span>
                <span class="text-gray-500 ml-2">from last week</span>
              </div>
            </div>
          </div>

          <!-- Charts and Analytics -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- User Growth Chart -->
            <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
              <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-lg text-gray-800">User Growth</h3>
                <div class="flex space-x-2">
                  <button onclick="switchChartView('weekly')" class="px-3 py-1 text-xs bg-gray-100 rounded-lg hover:bg-gray-200 smooth-transition">Weekly</button>
                  <button onclick="switchChartView('monthly')" class="px-3 py-1 text-xs bg-primary text-white rounded-lg smooth-transition">Monthly</button>
                  <button onclick="switchChartView('yearly')" class="px-3 py-1 text-xs bg-gray-100 rounded-lg hover:bg-gray-200 smooth-transition">Yearly</button>
                </div>
              </div>
              <div class="h-64">
                <canvas id="userGrowthChart"></canvas>
              </div>
            </div>

            <!-- Platform Distribution -->
            <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
              <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-lg text-gray-800">Platform Distribution</h3>
              </div>
              <div class="h-64">
                <canvas id="platformChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Recent Activity and Quick Actions -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Recent Users -->
            <div class="bg-white rounded-xl p-6 shadow border border-gray-100 lg:col-span-2">
              <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-lg text-gray-800">Recent Users</h3>
                <a href="#users" class="text-primary text-sm font-medium hover:underline">View all</a>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead>
                    <tr class="text-left text-xs text-gray-500 border-b border-gray-200">
                      <th class="pb-3 font-medium">User</th>
                      <th class="pb-3 font-medium">Joined</th>
                      <th class="pb-3 font-medium">Status</th>
                      <th class="pb-3 font-medium">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="recent-users-tbody">
                    <tr><td colspan="4" class="text-center py-8 text-gray-500">Loading users...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
              <h3 class="font-bold text-lg text-gray-800 mb-6">Quick Actions</h3>
              <div class="space-y-4">
                <button onclick="showAddUserModal()" class="w-full flex items-center space-x-3 p-4 bg-gray-50 hover:bg-gray-100 rounded-lg smooth-transition">
                  <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-user-plus text-primary"></i>
                  </div>
                  <div class="text-left">
                    <p class="font-medium text-sm">Add New User</p>
                    <p class="text-xs text-gray-500">Register new girl</p>
                  </div>
                </button>

                <button onclick="createProgram()" class="w-full flex items-center space-x-3 p-4 bg-gray-50 hover:bg-gray-100 rounded-lg smooth-transition">
                  <div class="w-10 h-10 bg-success/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus-circle text-success"></i>
                  </div>
                  <div class="text-left">
                    <p class="font-medium text-sm">Create Program</p>
                    <p class="text-xs text-gray-500">Add learning program</p>
                  </div>
                </button>

                <button onclick="viewReports()" class="w-full flex items-center space-x-3 p-4 bg-gray-50 hover:bg-gray-100 rounded-lg smooth-transition">
                  <div class="w-10 h-10 bg-warning/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-warning"></i>
                  </div>
                  <div class="text-left">
                    <p class="font-medium text-sm">View Reports</p>
                    <p class="text-xs text-gray-500">Analyze platform data</p>
                  </div>
                </button>

                <button onclick="openSettings()" class="w-full flex items-center space-x-3 p-4 bg-gray-50 hover:bg-gray-100 rounded-lg smooth-transition">
                  <div class="w-10 h-10 bg-info/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-cog text-info"></i>
                  </div>
                  <div class="text-left">
                    <p class="font-medium text-sm">Settings</p>
                    <p class="text-xs text-gray-500">Configure platform</p>
                  </div>
                </button>
              </div>
            </div>
          </div>

          <!-- System Status -->
          <div class="mt-8 bg-white rounded-xl p-6 shadow border border-gray-100">
            <h3 class="font-bold text-lg text-gray-800 mb-6">System Status</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-12 h-12 bg-success/10 rounded-full flex items-center justify-center">
                  <i class="fas fa-server text-success text-xl"></i>
                </div>
                <div>
                  <p class="font-medium">Server Status</p>
                  <p class="text-2xl font-bold text-success">Online</p>
                </div>
              </div>

              <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-12 h-12 bg-success/10 rounded-full flex items-center justify-center">
                  <i class="fas fa-database text-success text-xl"></i>
                </div>
                <div>
                  <p class="font-medium">Database</p>
                  <p class="text-2xl font-bold text-success">Connected</p>
                </div>
              </div>

              <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-12 h-12 bg-warning/10 rounded-full flex items-center justify-center">
                  <i class="fas fa-shield-alt text-warning text-xl"></i>
                </div>
                <div>
                  <p class="font-medium">Security</p>
                  <p class="text-2xl font-bold text-warning">Monitoring</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="users-section" class="hidden">
          <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
            <div class="flex items-center justify-between mb-6">
              <h3 class="font-bold text-lg text-gray-800">All Users</h3>
              <button onclick="showAddUserModal()" class="px-4 py-2 bg-gradient-to-r from-primary to-custom-purple text-white rounded-lg font-medium hover:shadow-lg smooth-transition flex items-center space-x-2">
                <i class="fas fa-plus"></i>
                <span>Add New User</span>
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="text-left text-xs text-gray-500 border-b border-gray-200">
                    <th class="pb-3">Photo</th>
                    <th class="pb-3">Name</th>
                    <th class="pb-3">Email</th>
                    <th class="pb-3">Phone</th>
                    <th class="pb-3">Status</th>
                    <th class="pb-3">Created</th>
                    <th class="pb-3">Actions</th>
                  </tr>
                </thead>
                <tbody id="all-users-tbody">
                  <tr><td colspan="7" class="text-center py-12 text-gray-500">Loading users...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Stories Section -->
        <div id="stories-section" class="hidden">
          <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
            <div class="flex items-center justify-between mb-6">
              <h3 class="font-bold text-lg text-gray-800">All Stories</h3>
              <div class="flex items-center space-x-2">
                <button onclick="filterStories('all')" class="px-3 py-1 text-xs bg-primary text-white rounded-lg">All</button>
                <button onclick="filterStories('pending')" class="px-3 py-1 text-xs bg-gray-100 rounded-lg hover:bg-gray-200">Pending</button>
                <button onclick="filterStories('approved')" class="px-3 py-1 text-xs bg-gray-100 rounded-lg hover:bg-gray-200">Approved</button>
                <button onclick="filterStories('rejected')" class="px-3 py-1 text-xs bg-gray-100 rounded-lg hover:bg-gray-200">Rejected</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="text-left text-xs text-gray-500 border-b border-gray-200">
                    <th class="pb-3">#</th>
                    <th class="pb-3">Title</th>
                    <th class="pb-3">Author</th>
                    <th class="pb-3">Category</th>
                    <th class="pb-3">Status</th>
                    <th class="pb-3">Date</th>
                    <th class="pb-3">Actions</th>
                  </tr>
                </thead>
                <tbody id="all-stories-tbody">
                  <tr><td colspan="7" class="text-center py-12 text-gray-500">Loading stories...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="hidden">
          <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
            <div class="flex items-center justify-between mb-6">
              <h3 class="font-bold text-lg text-gray-800">Platform Settings</h3>
              <button onclick="saveAllSettings()" class="px-4 py-2 bg-gradient-to-r from-primary to-custom-purple text-white rounded-lg font-medium hover:shadow-lg smooth-transition flex items-center space-x-2">
                <i class="fas fa-save"></i>
                <span>Save All Settings</span>
              </button>
            </div>
            
            <!-- Tabs Navigation -->
            <div class="mb-6 border-b border-gray-200">
              <div class="flex space-x-4">
                <button onclick="openSettingsTab('general')" id="tab-general" class="settings-tab active px-4 py-2 text-primary font-medium border-b-2 border-primary">General</button>
                <button onclick="openSettingsTab('users')" id="tab-users" class="settings-tab px-4 py-2 text-gray-600 hover:text-primary">Users & Permissions</button>
                <button onclick="openSettingsTab('content')" id="tab-content" class="settings-tab px-4 py-2 text-gray-600 hover:text-primary">Content</button>
                <button onclick="openSettingsTab('security')" id="tab-security" class="settings-tab px-4 py-2 text-gray-600 hover:text-primary">Security</button>
                <button onclick="openSettingsTab('notifications')" id="tab-notifications" class="settings-tab px-4 py-2 text-gray-600 hover:text-primary">Notifications</button>
                <button onclick="openSettingsTab('maintenance')" id="tab-maintenance" class="settings-tab px-4 py-2 text-gray-600 hover:text-primary">Maintenance</button>
              </div>
            </div>
            
            <!-- General Settings Tab -->
            <div id="settings-general" class="settings-content active space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Platform Name -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Platform Name</label>
                  <input type="text" id="setting-platform-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                  <p class="text-xs text-gray-500 mt-1">Display name for GirlsSpace platform</p>
                </div>
                
                <!-- Platform URL -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Platform URL</label>
                  <input type="url" id="setting-platform-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                  <p class="text-xs text-gray-500 mt-1">Main website URL</p>
                </div>
                
                <!-- Contact Email -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                  <input type="email" id="setting-contact-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                  <p class="text-xs text-gray-500 mt-1">Official contact email</p>
                </div>
                
                <!-- Support Phone -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Support Phone</label>
                  <input type="tel" id="setting-support-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                  <p class="text-xs text-gray-500 mt-1">Customer support phone number</p>
                </div>
                
                <!-- Default Language -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Default Language</label>
                  <select id="setting-default-language" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                    <option value="en">English</option>
                    <option value="fr">French</option>
                    <option value="rw">Kinyarwanda</option>
                    <option value="sw">Swahili</option>
                  </select>
                </div>
                
                <!-- Timezone -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                  <select id="setting-timezone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                    <option value="Africa/Kigali">Africa/Kigali (GMT+2)</option>
                    <option value="UTC">UTC</option>
                    <option value="America/New_York">America/New_York (GMT-5)</option>
                    <option value="Europe/London">Europe/London (GMT+0)</option>
                  </select>
                </div>
              </div>
              
              <!-- Platform Description -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Platform Description</label>
                <textarea id="setting-platform-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none"></textarea>
                <p class="text-xs text-gray-500 mt-1">Brief description shown in search engines</p>
              </div>
            </div>
            
            <!-- Users & Permissions Tab -->
            <div id="settings-users" class="settings-content hidden space-y-6">
              <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h4 class="font-medium text-gray-800 mb-2">User Registration Settings</h4>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Allow New Registrations</p>
                      <p class="text-sm text-gray-500">Allow new users to create accounts</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-allow-registration" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Require Email Verification</p>
                      <p class="text-sm text-gray-500">Users must verify email before login</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-require-email-verification" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Allow Anonymous Stories</p>
                      <p class="text-sm text-gray-500">Users can post stories without registration</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-allow-anonymous-stories" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-800 mb-2">Default User Permissions</h4>
                <div class="space-y-3">
                  <div class="flex items-center">
                    <input type="checkbox" id="setting-permission-post-stories" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked>
                    <label for="setting-permission-post-stories" class="ml-2 text-sm">Post Stories</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="setting-permission-comment" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked>
                    <label for="setting-permission-comment" class="ml-2 text-sm">Comment on Stories</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="setting-permission-join-chat" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked>
                    <label for="setting-permission-join-chat" class="ml-2 text-sm">Join Chat Rooms</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="setting-permission-report-content" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked>
                    <label for="setting-permission-report-content" class="ml-2 text-sm">Report Content</label>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Content Settings Tab -->
            <div id="settings-content" class="settings-content hidden space-y-6">
              <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h4 class="font-medium text-gray-800 mb-2">Story Settings</h4>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Story Status</label>
                    <select id="setting-default-story-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                      <option value="pending">Pending Review</option>
                      <option value="approved">Auto-approve</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Status for newly posted stories</p>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Story Character Limit</label>
                    <div class="flex items-center">
                      <input type="range" id="setting-story-limit-range" min="100" max="5000" step="100" value="2000" class="w-full mr-4">
                      <input type="number" id="setting-story-limit" min="100" max="5000" step="100" value="2000" class="w-24 px-3 py-2 border border-gray-300 rounded-lg">
                      <span class="ml-2 text-gray-600">characters</span>
                    </div>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Enable Story Categories</p>
                      <p class="text-sm text-gray-500">Allow categorization of stories</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-enable-categories" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-800 mb-2">Content Moderation</h4>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Auto-filter Inappropriate Content</p>
                      <p class="text-sm text-gray-500">Use AI to filter inappropriate words</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-auto-filter-content" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Banned Words List</label>
                    <textarea id="setting-banned-words" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none" placeholder="Enter banned words separated by commas">hate, violence, abuse, harassment</textarea>
                    <p class="text-xs text-gray-500 mt-1">Words that will trigger automatic content rejection</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Security Settings Tab -->
            <div id="settings-security" class="settings-content hidden space-y-6">
              <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h4 class="font-medium text-gray-800 mb-2">Authentication Security</h4>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Require Strong Passwords</p>
                      <p class="text-sm text-gray-500">Minimum 8 characters with mix of letters and numbers</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-strong-passwords" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Session Timeout</label>
                    <select id="setting-session-timeout" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                      <option value="30">30 minutes</option>
                      <option value="60" selected>1 hour</option>
                      <option value="120">2 hours</option>
                      <option value="240">4 hours</option>
                      <option value="720">12 hours</option>
                      <option value="1440">24 hours</option>
                    </select>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Enable Login Alerts</p>
                      <p class="text-sm text-gray-500">Send email alerts for new device logins</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-login-alerts" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-800 mb-2">Data Protection</h4>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Enable Data Encryption</p>
                      <p class="text-sm text-gray-500">Encrypt sensitive user data at rest</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-data-encryption" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">GDPR Compliance</p>
                      <p class="text-sm text-gray-500">Enable GDPR data protection features</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-gdpr-compliance" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Retention Period</label>
                    <select id="setting-data-retention" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                      <option value="90">90 days</option>
                      <option value="180">6 months</option>
                      <option value="365" selected>1 year</option>
                      <option value="730">2 years</option>
                      <option value="0">Forever</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">How long to keep user data after account deletion</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Notifications Settings Tab -->
            <div id="settings-notifications" class="settings-content hidden space-y-6">
              <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h4 class="font-medium text-gray-800 mb-2">Email Notifications</h4>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">New User Registration</p>
                      <p class="text-sm text-gray-500">Notify admins when new users register</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-notify-new-users" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">New Story Submission</p>
                      <p class="text-sm text-gray-500">Notify admins when new stories are posted</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-notify-new-stories" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Report Submission</p>
                      <p class="text-sm text-gray-500">Notify admins when content is reported</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-notify-reports" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-800 mb-2">Notification Templates</h4>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Welcome Email Subject</label>
                    <input type="text" id="setting-welcome-email-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none" value="Welcome to GirlsSpace!">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Welcome Email Body</label>
                    <textarea id="setting-welcome-email-body" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">Thank you for joining GirlsSpace! We're excited to have you in our community.</textarea>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Story Approved Notification</label>
                    <textarea id="setting-story-approved-notification" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">Your story has been approved and is now live on GirlsSpace!</textarea>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Maintenance Settings Tab -->
            <div id="settings-maintenance" class="settings-content hidden space-y-6">
              <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h4 class="font-medium text-gray-800 mb-2">System Maintenance</h4>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium">Maintenance Mode</p>
                      <p class="text-sm text-gray-500">Take site offline for maintenance</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="setting-maintenance-mode" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  
                  <div id="maintenance-message-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Maintenance Message</label>
                    <textarea id="setting-maintenance-message" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">GirlsSpace is currently undergoing maintenance. We'll be back soon!</textarea>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Auto-Backup Schedule</label>
                    <select id="setting-backup-schedule" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                      <option value="daily">Daily</option>
                      <option value="weekly" selected>Weekly</option>
                      <option value="monthly">Monthly</option>
                      <option value="disabled">Disabled</option>
                    </select>
                  </div>
                  
                  <div class="pt-4">
                    <button onclick="runSystemBackup()" class="px-4 py-2 bg-warning text-white rounded-lg font-medium hover:bg-yellow-600 smooth-transition">
                      <i class="fas fa-database mr-2"></i>
                      Run Manual Backup
                    </button>
                    <p class="text-xs text-gray-500 mt-2">Create a backup of all platform data</p>
                  </div>
                </div>
              </div>
              
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-800 mb-2">Cache Management</h4>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cache Duration</label>
                    <select id="setting-cache-duration" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                      <option value="3600" selected>1 hour</option>
                      <option value="86400">24 hours</option>
                      <option value="604800">1 week</option>
                      <option value="0">No caching</option>
                    </select>
                  </div>
                  
                  <div class="pt-4">
                    <button onclick="clearAllCache()" class="px-4 py-2 bg-danger text-white rounded-lg font-medium hover:bg-red-600 smooth-transition">
                      <i class="fas fa-broom mr-2"></i>
                      Clear All Cache
                    </button>
                    <p class="text-xs text-gray-500 mt-2">Clear all cached data and refresh</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 modal-overlay">
    <div class="bg-white rounded-xl max-w-md w-full">
      <div class="p-6">
        <div class="flex justify-between items-start mb-6">
          <h3 class="text-2xl font-bold text-gray-800">Add New User</h3>
          <button onclick="closeModal('add-user-modal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
       
        <form id="add-user-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
            <input type="text" id="new-user-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
          </div>
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
            <input type="email" id="new-user-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
          </div>
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <input type="password" id="new-user-password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
            <p class="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
          </div>
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number (Optional)</label>
            <input type="tel" id="new-user-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
          </div>
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="new-user-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
          </div>
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
            <select id="new-user-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
         
          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" onclick="closeModal('add-user-modal')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 bg-gradient-to-r from-primary to-custom-purple text-white rounded-lg font-medium hover:shadow-lg">
              Create User
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 modal-overlay">
    <div class="bg-white rounded-xl max-w-md w-full">
      <div class="p-6">
        <div class="flex justify-between items-start mb-6">
          <h3 class="text-2xl font-bold text-gray-800">Edit User</h3>
          <button onclick="closeModal('edit-user-modal')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
       
        <form id="edit-user-form" class="space-y-4">
          <input type="hidden" id="edit-user-id">
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
            <input type="text" id="edit-user-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
          </div>
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
            <input type="email" id="edit-user-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
          </div>
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
            <input type="tel" id="edit-user-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
          </div>
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="edit-user-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
          </div>
         
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
            <select id="edit-user-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
         
          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" onclick="closeModal('edit-user-modal')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 bg-gradient-to-r from-primary to-custom-purple text-white rounded-lg font-medium hover:shadow-lg">
              Update User
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Story Modal -->
  <div id="story-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3 id="story-modal-title" class="text-2xl font-bold text-gray-800 mb-2">Story Details</h3>
            <p id="story-modal-subtitle" class="text-gray-600"></p>
            <span id="story-modal-status" class="status-badge mt-2"></span>
          </div>
          <button onclick="closeModal('story-modal')" class="text-gray-400 hover:text-gray-600 text-2xl"></button>
        </div>
        <div id="story-modal-content" class="text-gray-700 leading-relaxed whitespace-pre-line mb-6"></div>
        <div id="story-modal-actions" class="flex justify-end space-x-3">
          <!-- Actions will be added dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript Logic -->
  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      query,
      orderBy,
      limit,
      where,
      doc,
      deleteDoc,
      updateDoc,
      setDoc,
      serverTimestamp,
      getDocs,
      addDoc,
      getDoc,
      getCountFromServer
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD5K27SYd3NzV5FOtMtPZs_l8UhEUq42zc",
      authDomain: "sigin-b3aa1.firebaseapp.com",
      projectId: "sigin-b3aa1",
      storageBucket: "sigin-b3aa1.firebasestorage.app",
      messagingSenderId: "390069352394",
      appId: "1:390069352394:web:aa32d4a640b6f7fee54133"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
   
    // Global Variables
    let unsubscribes = [];
    let allUsers = [];
    let allStories = [];
    let filteredStories = [];
    let userGrowthChart = null;
    let platformChart = null;
    let currentChartView = 'monthly';
    let currentAdminId = null;

    // ======================
    // UTILITY FUNCTIONS
    // ======================

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
     
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Format date
    function formatDate(date) {
      if (!date) return 'N/A';
      try {
        if (date.toDate) {
          date = date.toDate();
        }
        return date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return 'Invalid Date';
      }
    }

    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    // Validate email
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // Get status badge class
    function getStatusClass(status) {
      switch(status) {
        case 'active': return 'status-active';
        case 'pending': return 'status-pending';
        case 'inactive': return 'status-inactive';
        case 'approved': return 'status-active';
        case 'rejected': return 'status-warning';
        default: return 'status-inactive';
      }
    }

    // Get status text
    function getStatusText(status) {
      switch(status) {
        case 'active': return 'Active';
        case 'pending': return 'Pending';
        case 'inactive': return 'Inactive';
        case 'approved': return 'Approved';
        case 'rejected': return 'Rejected';
        default: return 'Unknown';
      }
    }

    // Show add user modal
    window.showAddUserModal = () => {
      document.getElementById('add-user-modal').classList.remove('hidden');
    };

    // Show edit user modal
    window.showEditUserModal = (userId) => {
      const user = allUsers.find(u => u.id === userId);
      if (!user) {
        showToast('User not found', 'error');
        return;
      }

      document.getElementById('edit-user-id').value = userId;
      document.getElementById('edit-user-name').value = user.displayName || '';
      document.getElementById('edit-user-email').value = user.email || '';
      document.getElementById('edit-user-phone').value = user.phoneNumber || user.phone || '';
      document.getElementById('edit-user-status').value = user.status || 'active';
      document.getElementById('edit-user-role').value = user.role || 'user';

      document.getElementById('edit-user-modal').classList.remove('hidden');
    };

    // Switch chart view
    window.switchChartView = (view) => {
      currentChartView = view;
     
      // Update button styles
      document.querySelectorAll('#dashboard-section .bg-primary').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-800');
      });
     
      const activeBtn = document.querySelector(`#dashboard-section button:nth-child(${
        view === 'weekly' ? 1 : view === 'monthly' ? 2 : 3
      })`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-gray-100', 'text-gray-800');
        activeBtn.classList.add('bg-primary', 'text-white');
      }
     
      // Update chart with new view
      if (allUsers.length > 0) {
        analyzeUserGrowth();
      }
    };

    // Analyze user growth for charts
    function analyzeUserGrowth() {
      if (allUsers.length === 0) return;

      const now = new Date();
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      let labels = [];
      let cumulativeData = [];
      let newUsersData = [];

      if (currentChartView === 'monthly') {
        // Last 6 months
        for (let i = 5; i >= 0; i--) {
          const date = new Date();
          date.setMonth(date.getMonth() - i);
          const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
          const monthLabel = `${monthNames[date.getMonth()]} ${date.getFullYear().toString().substr(-2)}`;
          labels.push(monthLabel);
         
          let monthCount = 0;
          allUsers.forEach(user => {
            if (user.createdAt) {
              const userDate = user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt);
              if (userDate.getFullYear() === date.getFullYear() && userDate.getMonth() === date.getMonth()) {
                monthCount++;
              }
            }
          });
          newUsersData.push(monthCount);
        }

        // Calculate cumulative
        let cumulative = 0;
        cumulativeData = newUsersData.map(count => {
          cumulative += count;
          return cumulative;
        });
      }
      else if (currentChartView === 'weekly') {
        // Last 8 weeks
        for (let i = 7; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - (i * 7));
          const weekStart = new Date(date);
          weekStart.setDate(weekStart.getDate() - weekStart.getDay());
          const weekLabel = `Week ${Math.floor((date.getDate() - 1) / 7) + 1}`;
          labels.push(weekLabel);
         
          let weekCount = 0;
          allUsers.forEach(user => {
            if (user.createdAt) {
              const userDate = user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt);
              const weekEnd = new Date(weekStart);
              weekEnd.setDate(weekEnd.getDate() + 6);
             
              if (userDate >= weekStart && userDate <= weekEnd) {
                weekCount++;
              }
            }
          });
          newUsersData.push(weekCount);
        }

        // Calculate cumulative
        let cumulative = 0;
        cumulativeData = newUsersData.map(count => {
          cumulative += count;
          return cumulative;
        });
      }
      else if (currentChartView === 'yearly') {
        // Last 5 years
        const currentYear = now.getFullYear();
        for (let year = currentYear - 4; year <= currentYear; year++) {
          labels.push(year.toString());
         
          let yearCount = 0;
          allUsers.forEach(user => {
            if (user.createdAt) {
              const userDate = user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt);
              if (userDate.getFullYear() === year) {
                yearCount++;
              }
            }
          });
          newUsersData.push(yearCount);
        }

        // Calculate cumulative
        let cumulative = 0;
        cumulativeData = newUsersData.map(count => {
          cumulative += count;
          return cumulative;
        });
      }

      // Calculate percentage change for users
      const lastIndex = newUsersData.length - 1;
      const previousIndex = lastIndex - 1;
      let percentageChange = 0;
     
      if (previousIndex >= 0 && newUsersData[previousIndex] > 0) {
        percentageChange = ((newUsersData[lastIndex] - newUsersData[previousIndex]) / newUsersData[previousIndex] * 100).toFixed(1);
      } else if (newUsersData[lastIndex] > 0) {
        percentageChange = 100;
      }

      // Update the percentage display
      const changeElement = document.getElementById('users-change');
      if (changeElement) {
        const arrowIcon = percentageChange >= 0 ?
          '<i class="fas fa-arrow-up mr-1"></i>' :
          '<i class="fas fa-arrow-down mr-1"></i>';
        const textColor = percentageChange >= 0 ? 'text-success' : 'text-danger';
       
        changeElement.innerHTML = `${arrowIcon}${Math.abs(percentageChange)}%`;
        changeElement.className = `${textColor} flex items-center`;
      }

      // Update the chart
      updateUserGrowthChart(labels, cumulativeData, newUsersData);
    }

    // Update User Growth Chart
    function updateUserGrowthChart(labels, cumulativeData, monthlyData) {
      const ctx = document.getElementById('userGrowthChart');
      if (!ctx) return;
     
      if (userGrowthChart) {
        userGrowthChart.destroy();
      }
     
      userGrowthChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Total Users',
              data: cumulativeData,
              borderColor: '#ec4899',
              backgroundColor: 'rgba(236, 72, 153, 0.1)',
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#ec4899',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: 'New Users',
              data: monthlyData,
              borderColor: '#c23cb6',
              backgroundColor: 'rgba(194, 60, 182, 0.1)',
              fill: false,
              tension: 0.4,
              borderDash: [5, 5],
              pointBackgroundColor: '#c23cb6',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: '#6b7280',
                font: {
                  family: "'Inter', sans-serif",
                  size: 11
                },
                boxWidth: 12,
                padding: 16
              }
            },
            tooltip: {
              backgroundColor: 'rgba(15, 15, 20, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#ec4899',
              borderWidth: 1,
              cornerRadius: 8,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.parsed.y;
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              },
              ticks: {
                color: '#6b7280',
                font: {
                  family: "'Inter', sans-serif",
                  size: 11
                }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              },
              ticks: {
                color: '#6b7280',
                font: {
                  family: "'Inter', sans-serif",
                  size: 11
                },
                callback: function(value) {
                  if (value >= 1000) {
                    return (value / 1000) + 'k';
                  }
                  return value;
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          animations: {
            tension: {
              duration: 1000,
              easing: 'linear'
            }
          }
        }
      });
    }

    // Initialize Platform Chart
    function initializePlatformChart() {
      const platformCtx = document.getElementById('platformChart');
      if (!platformCtx || platformChart) return;
     
      platformChart = new Chart(platformCtx.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['Mobile', 'Desktop', 'Tablet'],
          datasets: [{
            data: [65, 25, 10],
            backgroundColor: ['#ec4899', '#c23cb6', '#fbbf24'],
            borderWidth: 2,
            borderColor: '#fff',
            hoverOffset: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#6b7280',
                padding: 16,
                font: {
                  family: "'Inter', sans-serif",
                  size: 11
                }
              }
            }
          },
          cutout: '70%'
        }
      });
    }

    // ======================
    // ADMIN SPECIFIC FUNCTIONS
    // ======================

    // Check if user is admin in admins collection
    async function checkAdminStatus(userId) {
      try {
        const adminRef = doc(db, "admins", userId);
        const adminSnap = await getDoc(adminRef);
       
        if (adminSnap.exists()) {
          currentAdminId = adminSnap.id;
          return true;
        }
       
        // Also check by email if not found by ID
        if (auth.currentUser && auth.currentUser.email) {
          const adminQuery = query(
            collection(db, "admins"),
            where("email", "==", auth.currentUser.email)
          );
          const querySnapshot = await getDocs(adminQuery);
         
          if (!querySnapshot.empty) {
            currentAdminId = querySnapshot.docs[0].id;
            return true;
          }
        }
       
        return false;
      } catch (error) {
        console.error("Error checking admin status:", error);
        return false;
      }
    }

    // Create admin document for new admin users
    async function createAdminDocument(userId, userEmail, userName) {
      try {
        await setDoc(doc(db, "admins", userId), {
          email: userEmail,
          name: userName,
          createdAt: serverTimestamp(),
          role: "admin",
          permissions: ["users:read", "users:write", "stories:read", "stories:write", "reports:read"]
        });
        return true;
      } catch (error) {
        console.error("Error creating admin document:", error);
        return false;
      }
    }

    // ======================
    // SETTINGS FUNCTIONS -  
    // ======================

    // Open settings tab
    window.openSettingsTab = (tabName) => {
      // Update tab buttons
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active', 'text-primary', 'border-primary');
        tab.classList.add('text-gray-600');
      });
     
      const activeTab = document.getElementById(`tab-${tabName}`);
      if (activeTab) {
        activeTab.classList.add('active', 'text-primary', 'border-primary');
        activeTab.classList.remove('text-gray-600');
      }
     
      // Update content
      document.querySelectorAll('.settings-content').forEach(content => {
        content.classList.add('hidden');
        content.classList.remove('active');
      });
     
      const activeContent = document.getElementById(`settings-${tabName}`);
      if (activeContent) {
        activeContent.classList.remove('hidden');
        activeContent.classList.add('active');
      }
    };

    // Load settings from Firestore
    async function loadSettings() {
      try {
        if (!currentAdminId) {
          console.log("   currentAdminId");
          return;
        }

        const isAdmin = await checkAdminStatus(currentAdminId);
        if (!isAdmin) {
          showToast('Admin privileges required to access settings', 'error');
          return;
        }
       
        const settingsRef = doc(db, "settings", "platform");
        const settingsSnap = await getDoc(settingsRef);
       
        if (settingsSnap.exists()) {
          const settings = settingsSnap.data();
          console.log("   :", settings);
         
          // General Settings
          if (document.getElementById('setting-platform-name')) {
            document.getElementById('setting-platform-name').value = settings.platformName || 'GirlsSpace Mahama';
            document.getElementById('setting-platform-url').value = settings.platformUrl || '';
            document.getElementById('setting-contact-email').value = settings.contactEmail || '';
            document.getElementById('setting-support-phone').value = settings.supportPhone || '';
            document.getElementById('setting-default-language').value = settings.defaultLanguage || 'en';
            document.getElementById('setting-timezone').value = settings.timezone || 'Africa/Kigali';
            document.getElementById('setting-platform-description').value = settings.platformDescription || '';
          }
         
          // User Settings
          if (document.getElementById('setting-allow-registration')) {
            document.getElementById('setting-allow-registration').checked = settings.allowRegistration !== false;
            document.getElementById('setting-require-email-verification').checked = settings.requireEmailVerification || false;
            document.getElementById('setting-allow-anonymous-stories').checked = settings.allowAnonymousStories || false;
          }
         
          // User Permissions
          const permissions = settings.userPermissions || {};
          if (document.getElementById('setting-permission-post-stories')) {
            document.getElementById('setting-permission-post-stories').checked = permissions.postStories !== false;
            document.getElementById('setting-permission-comment').checked = permissions.comment || false;
            document.getElementById('setting-permission-join-chat').checked = permissions.joinChat || false;
            document.getElementById('setting-permission-report-content').checked = permissions.reportContent || false;
          }
         
          // Content Settings
          if (document.getElementById('setting-default-story-status')) {
            document.getElementById('setting-default-story-status').value = settings.defaultStoryStatus || 'pending';
            document.getElementById('setting-story-limit').value = settings.storyCharacterLimit || 2000;
            document.getElementById('setting-story-limit-range').value = settings.storyCharacterLimit || 2000;
            document.getElementById('setting-enable-categories').checked = settings.enableCategories || false;
            document.getElementById('setting-auto-filter-content').checked = settings.autoFilterContent || false;
            document.getElementById('setting-banned-words').value = settings.bannedWords ? settings.bannedWords.join(', ') : '';
          }
         
          // Security Settings
          if (document.getElementById('setting-strong-passwords')) {
            document.getElementById('setting-strong-passwords').checked = settings.requireStrongPasswords || false;
            document.getElementById('setting-session-timeout').value = settings.sessionTimeout || 60;
            document.getElementById('setting-login-alerts').checked = settings.enableLoginAlerts || false;
            document.getElementById('setting-data-encryption').checked = settings.enableDataEncryption || false;
            document.getElementById('setting-gdpr-compliance').checked = settings.gdprCompliance || false;
            document.getElementById('setting-data-retention').value = settings.dataRetentionPeriod || 365;
          }
         
          // Notification Settings
          if (document.getElementById('setting-notify-new-users')) {
            document.getElementById('setting-notify-new-users').checked = settings.notifyNewUsers !== false;
            document.getElementById('setting-notify-new-stories').checked = settings.notifyNewStories || false;
            document.getElementById('setting-notify-reports').checked = settings.notifyReports || false;
            document.getElementById('setting-welcome-email-subject').value = settings.welcomeEmailSubject || 'Welcome to GirlsSpace!';
            document.getElementById('setting-welcome-email-body').value = settings.welcomeEmailBody || '';
            document.getElementById('setting-story-approved-notification').value = settings.storyApprovedNotification || '';
          }
         
          // Maintenance Settings
          if (document.getElementById('setting-maintenance-mode')) {
            document.getElementById('setting-maintenance-mode').checked = settings.maintenanceMode || false;
            document.getElementById('setting-maintenance-message').value = settings.maintenanceMessage || '';
            document.getElementById('setting-backup-schedule').value = settings.backupSchedule || 'weekly';
            document.getElementById('setting-cache-duration').value = settings.cacheDuration || 3600;
          }
         
          // Toggle maintenance message visibility
          toggleMaintenanceMessage();
         
        } else {
          // Initialize default settings
          console.log("       ...");
          await initializeDefaultSettings();
        }
      } catch (error) {
        console.error('    :', error);
        showToast('Failed to load settings: ' + error.message, 'error');
      }
    }

    // Initialize default settings
    async function initializeDefaultSettings() {
      try {
        const defaultSettings = {
          platformName: 'GirlsSpace Mahama',
          platformUrl: '',
          contactEmail: '',
          supportPhone: '',
          defaultLanguage: 'en',
          timezone: 'Africa/Kigali',
          platformDescription: 'A safe space for girls in Mahama Refugee Camp to share stories and connect.',
         
          // User Settings
          allowRegistration: true,
          requireEmailVerification: false,
          allowAnonymousStories: true,
         
          // User Permissions
          userPermissions: {
            postStories: true,
            comment: true,
            joinChat: true,
            reportContent: true
          },
         
          // Content Settings
          defaultStoryStatus: 'pending',
          storyCharacterLimit: 2000,
          enableCategories: true,
          autoFilterContent: true,
          bannedWords: ['hate', 'violence', 'abuse', 'harassment'],
         
          // Security Settings
          requireStrongPasswords: true,
          sessionTimeout: 60,
          enableLoginAlerts: false,
          enableDataEncryption: false,
          gdprCompliance: false,
          dataRetentionPeriod: 365,
         
          // Notification Settings
          notifyNewUsers: true,
          notifyNewStories: true,
          notifyReports: true,
          welcomeEmailSubject: 'Welcome to GirlsSpace!',
          welcomeEmailBody: 'Thank you for joining GirlsSpace! We\'re excited to have you in our community.',
          storyApprovedNotification: 'Your story has been approved and is now live on GirlsSpace!',
         
          // Maintenance Settings
          maintenanceMode: false,
          maintenanceMessage: 'GirlsSpace is currently undergoing maintenance. We\'ll be back soon!',
          backupSchedule: 'weekly',
          cacheDuration: 3600,
         
          // System
          lastUpdated: serverTimestamp(),
          updatedBy: currentAdminId,
          createdAt: serverTimestamp()
        };
       
        const settingsRef = doc(db, "settings", "platform");
        await setDoc(settingsRef, defaultSettings);
        console.log("    ");
        
        // Load the settings after creating them
        loadSettings();
      } catch (error) {
        console.error('     :', error);
      }
    }

    // Save all settings -   
    window.saveAllSettings = async () => {
      try {
        console.log("    ...");
        
        // 1.    
        if (!auth.currentUser) {
          showToast('   ', 'error');
          window.location.href = './login.html';
          return;
        }
        
        console.log("  :", auth.currentUser.email);
        
        // 2.    
        const isAdmin = await checkAdminStatus(auth.currentUser.uid);
        console.log("  :", isAdmin);
        
        if (!isAdmin) {
          showToast('    ', 'error');
          return;
        }
        
        // 3.    
        const settingsData = {
          // General
          platformName: document.getElementById('setting-platform-name').value,
          platformUrl: document.getElementById('setting-platform-url').value,
          contactEmail: document.getElementById('setting-contact-email').value,
          supportPhone: document.getElementById('setting-support-phone').value,
          defaultLanguage: document.getElementById('setting-default-language').value,
          timezone: document.getElementById('setting-timezone').value,
          platformDescription: document.getElementById('setting-platform-description').value,
          
          // Users
          allowRegistration: document.getElementById('setting-allow-registration').checked,
          requireEmailVerification: document.getElementById('setting-require-email-verification').checked,
          allowAnonymousStories: document.getElementById('setting-allow-anonymous-stories').checked,
          
          // Permissions
          userPermissions: {
            postStories: document.getElementById('setting-permission-post-stories').checked,
            comment: document.getElementById('setting-permission-comment').checked,
            joinChat: document.getElementById('setting-permission-join-chat').checked,
            reportContent: document.getElementById('setting-permission-report-content').checked
          },
          
          // Content
          defaultStoryStatus: document.getElementById('setting-default-story-status').value,
          storyCharacterLimit: parseInt(document.getElementById('setting-story-limit').value) || 2000,
          enableCategories: document.getElementById('setting-enable-categories').checked,
          autoFilterContent: document.getElementById('setting-auto-filter-content').checked,
          bannedWords: document.getElementById('setting-banned-words').value
            .split(',')
            .map(w => w.trim())
            .filter(w => w.length > 0),
          
          // Security
          requireStrongPasswords: document.getElementById('setting-strong-passwords').checked,
          sessionTimeout: parseInt(document.getElementById('setting-session-timeout').value) || 60,
          enableLoginAlerts: document.getElementById('setting-login-alerts').checked,
          enableDataEncryption: document.getElementById('setting-data-encryption').checked,
          gdprCompliance: document.getElementById('setting-gdpr-compliance').checked,
          dataRetentionPeriod: parseInt(document.getElementById('setting-data-retention').value) || 365,
          
          // Notifications
          notifyNewUsers: document.getElementById('setting-notify-new-users').checked,
          notifyNewStories: document.getElementById('setting-notify-new-stories').checked,
          notifyReports: document.getElementById('setting-notify-reports').checked,
          welcomeEmailSubject: document.getElementById('setting-welcome-email-subject').value,
          welcomeEmailBody: document.getElementById('setting-welcome-email-body').value,
          storyApprovedNotification: document.getElementById('setting-story-approved-notification').value,
          
          // Maintenance
          maintenanceMode: document.getElementById('setting-maintenance-mode').checked,
          maintenanceMessage: document.getElementById('setting-maintenance-message').value,
          backupSchedule: document.getElementById('setting-backup-schedule').value,
          cacheDuration: parseInt(document.getElementById('setting-cache-duration').value) || 3600,
          
          // Metadata
          lastUpdated: serverTimestamp(),
          updatedBy: auth.currentUser.uid,
          updatedByEmail: auth.currentUser.email
        };
        
        console.log("  :", settingsData);
        
        // 4.    Firestore
        const settingsRef = doc(db, "settings", "platform");
        console.log("   :", settingsRef.path);
        
        await setDoc(settingsRef, settingsData, { merge: true });
        
        console.log("   !");
        showToast('   ', 'success');
        
        // 5.   
        const saveBtn = document.querySelector('button[onclick="saveAllSettings()"]');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i> !';
        saveBtn.classList.remove('from-primary', 'to-custom-purple');
        saveBtn.classList.add('bg-green-500');
        
        setTimeout(() => {
          saveBtn.innerHTML = originalText;
          saveBtn.classList.remove('bg-green-500');
          saveBtn.classList.add('from-primary', 'to-custom-purple');
        }, 2000);
        
      } catch (error) {
        console.error("    :", error);
        
        let errorMessage = '   : ';
        
        if (error.code === 'permission-denied') {
          errorMessage = '  .      .';
        } else if (error.code === 'unavailable') {
          errorMessage = '   .    .';
        } else {
          errorMessage += error.message;
        }
        
        showToast(errorMessage, 'error');
        
        //    
        const errorDiv = document.createElement('div');
        errorDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
        errorDiv.innerHTML = `
          <h4 class="font-bold text-red-700"> :</h4>
          <p class="text-sm text-red-600 mb-2">${errorMessage}</p>
          <button onclick="fixSettingsIssue()" class="px-3 py-1 bg-red-600 text-white text-sm rounded">
             
          </button>
        `;
        
        const settingsSection = document.getElementById('settings-section');
        const existingError = settingsSection.querySelector('.error-fix');
        if (existingError) existingError.remove();
        
        errorDiv.classList.add('error-fix');
        settingsSection.appendChild(errorDiv);
      }
    };

    //   
    window.fixSettingsIssue = async () => {
      try {
        // 1.   settings    
        const settingsRef = doc(db, "settings", "platform");
        
        // 2.     
        const testData = {
          test: true,
          createdAt: serverTimestamp(),
          createdBy: auth.currentUser.uid
        };
        
        await setDoc(settingsRef, testData, { merge: true });
        showToast('   .     .', 'success');
        
        //   
        const errorDiv = document.querySelector('.error-fix');
        if (errorDiv) errorDiv.remove();
        
      } catch (fixError) {
        console.error("  :", fixError);
        showToast(` : ${fixError.message}`, 'error');
      }
    };

    // Toggle maintenance message visibility
    function toggleMaintenanceMessage() {
      const maintenanceMode = document.getElementById('setting-maintenance-mode');
      const messageSection = document.getElementById('maintenance-message-section');
     
      if (maintenanceMode && messageSection) {
        if (maintenanceMode.checked) {
          messageSection.classList.remove('hidden');
        } else {
          messageSection.classList.add('hidden');
        }
      }
    }

    // Run system backup
    window.runSystemBackup = async () => {
      try {
        const isAdmin = await checkAdminStatus(currentAdminId);
        if (!isAdmin) {
          showToast('Admin privileges required to run backups', 'error');
          return;
        }
       
        // Create backup document
        const backupData = {
          timestamp: serverTimestamp(),
          createdBy: currentAdminId,
          status: 'in-progress'
        };
       
        const backupRef = await addDoc(collection(db, "backups"), backupData);
       
        // In a real implementation, this would trigger a cloud function
        // For now, we'll simulate the backup process
        showToast('Backup process started...', 'info');
       
        setTimeout(async () => {
          await updateDoc(backupRef, {
            status: 'completed',
            completedAt: serverTimestamp(),
            size: Math.floor(Math.random() * 500) + 100 // Simulated file size in MB
          });
         
          showToast('Backup completed successfully!', 'success');
        }, 3000);
      } catch (error) {
        console.error('Error running backup:', error);
        showToast('Failed to run backup: ' + error.message, 'error');
      }
    };

    // Clear all cache
    window.clearAllCache = async () => {
      try {
        const isAdmin = await checkAdminStatus(currentAdminId);
        if (!isAdmin) {
          showToast('Admin privileges required to clear cache', 'error');
          return;
        }
       
        // In a real implementation, this would clear server cache
        // For now, we'll just show a message
        showToast('Cache cleared successfully. Page will refresh.', 'success');
       
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } catch (error) {
        console.error('Error clearing cache:', error);
        showToast('Failed to clear cache: ' + error.message, 'error');
      }
    };

    // Link range input with number input for story limit
    function linkStoryLimitInputs() {
      const rangeInput = document.getElementById('setting-story-limit-range');
      const numberInput = document.getElementById('setting-story-limit');
     
      if (rangeInput && numberInput) {
        rangeInput.addEventListener('input', function() {
          numberInput.value = this.value;
        });
       
        numberInput.addEventListener('input', function() {
          rangeInput.value = this.value;
        });
      }
    }

    // Initialize maintenance mode toggle
    function initMaintenanceToggle() {
      const maintenanceToggle = document.getElementById('setting-maintenance-mode');
      if (maintenanceToggle) {
        maintenanceToggle.addEventListener('change', toggleMaintenanceMessage);
      }
    }

    // ======================
    // GLOBAL FUNCTIONS
    // ======================

    // Logout
    window.logout = async () => {
      unsubscribes.forEach(u => u && u());
      unsubscribes = [];
      await signOut(auth);
      window.location.href = './login.html';
    };

    // View user details
    window.viewUser = async (id) => {
      const user = allUsers.find(u => u.id === id);
      if (!user) {
        showToast('User not found', 'error');
        return;
      }

      // Create a simple view modal
      const modalContent = `
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
          <div class="flex justify-between items-start mb-6">
            <h3 class="text-xl font-bold">User Details</h3>
            <button onclick="closeUserViewModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          <div class="space-y-4">
            <div class="flex items-center space-x-4">
              <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'U')}&background=ec4899&color=fff`}"
                   class="w-16 h-16 rounded-full">
              <div>
                <h4 class="font-bold text-lg">${user.displayName || 'Not specified'}</h4>
                <p class="text-gray-600">${user.email || 'N/A'}</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-500">Status</p>
                <span class="status-badge ${getStatusClass(user.status)}">
                  ${getStatusText(user.status)}
                </span>
              </div>
              <div>
                <p class="text-sm text-gray-500">Role</p>
                <p>${user.role || 'user'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Phone</p>
                <p>${user.phoneNumber || user.phone || 'N/A'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Created</p>
                <p>${formatDate(user.createdAt)}</p>
              </div>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button onclick="closeUserViewModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
              Close
            </button>
            <button onclick="showEditUserModal('${id}')" class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded-lg">
              Edit
            </button>
          </div>
        </div>
      `;

      // Create modal container
      const modal = document.createElement('div');
      modal.id = 'user-view-modal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4';
      modal.innerHTML = modalContent;
      document.body.appendChild(modal);
      modal.classList.remove('hidden');

      // Close function
      window.closeUserViewModal = () => {
        modal.classList.add('hidden');
        setTimeout(() => modal.remove(), 300);
      };
    };

    // Edit user form submission
    document.getElementById('edit-user-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
     
      const userId = document.getElementById('edit-user-id').value;
      const name = document.getElementById('edit-user-name').value;
      const email = document.getElementById('edit-user-email').value;
      const phone = document.getElementById('edit-user-phone').value;
      const status = document.getElementById('edit-user-status').value;
      const role = document.getElementById('edit-user-role').value;
     
      if (!validateEmail(email)) {
        showToast('Invalid email address', 'error');
        return;
      }
     
      try {
        // First check if we're admin
        const isAdmin = await checkAdminStatus(currentAdminId);
        if (!isAdmin) {
          showToast('Admin privileges required to edit users', 'error');
          return;
        }
       
        await updateDoc(doc(db, "users", userId), {
          displayName: name,
          email: email,
          phoneNumber: phone,
          status: status,
          role: role,
          updatedAt: serverTimestamp()
        });
       
        // If making someone admin, add them to admins collection
        if (role === 'admin' && status === 'active') {
          await createAdminDocument(userId, email, name);
        }
       
        closeModal('edit-user-modal');
        showToast('User updated successfully', 'success');
      } catch (error) {
        console.error('Error updating user:', error);
       
        // Check for specific permission errors
        if (error.code === 'permission-denied') {
          showToast('Permission denied. You need admin privileges to edit users.', 'error');
        } else {
          showToast('Failed to update user: ' + error.message, 'error');
        }
      }
    });

    // Add user form submission
    document.getElementById('add-user-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
     
      const name = document.getElementById('new-user-name').value;
      const email = document.getElementById('new-user-email').value;
      const password = document.getElementById('new-user-password').value;
      const phone = document.getElementById('new-user-phone').value;
      const status = document.getElementById('new-user-status').value;
      const role = document.getElementById('new-user-role').value;
     
      if (!validateEmail(email)) {
        showToast('Invalid email address', 'error');
        return;
      }
     
      if (password.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
      }
     
      try {
        // First check if we're admin
        const isAdmin = await checkAdminStatus(currentAdminId);
        if (!isAdmin) {
          showToast('Admin privileges required to create users', 'error');
          return;
        }
       
        // Create user in Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const userId = userCredential.user.uid;
       
        // Create user document in Firestore
        await setDoc(doc(db, "users", userId), {
          displayName: name,
          email: email,
          phoneNumber: phone,
          status: status,
          role: role,
          photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ec4899&color=fff`,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          uid: userId
        });
       
        // If creating an admin user, add to admins collection
        if (role === 'admin' && status === 'active') {
          await createAdminDocument(userId, email, name);
        }
       
        closeModal('add-user-modal');
        showToast('User created successfully', 'success');
       
        // Clear form
        document.getElementById('add-user-form').reset();
      } catch (error) {
        console.error('Error creating user:', error);
       
        // Check for specific permission errors
        if (error.code === 'permission-denied') {
          showToast('Permission denied. You need admin privileges to create users.', 'error');
        } else {
          let errorMessage = 'Failed to create user: ';
          switch(error.code) {
            case 'auth/email-already-in-use':
              errorMessage += 'Email is already registered';
              break;
            case 'auth/invalid-email':
              errorMessage += 'Invalid email address';
              break;
            case 'auth/weak-password':
              errorMessage += 'Password is too weak';
              break;
            default:
              errorMessage += error.message;
          }
          showToast(errorMessage, 'error');
        }
      }
    });

    // Delete user
    window.deleteUser = async (id) => {
      const user = allUsers.find(u => u.id === id);
      if (!user) {
        showToast('User not found', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to delete user "${user.displayName}"? This action cannot be undone.`)) {
        return;
      }

      try {
        // First check if we're admin
        const isAdmin = await checkAdminStatus(currentAdminId);
        if (!isAdmin) {
          showToast('Admin privileges required to delete users', 'error');
          return;
        }
       
        // Delete user document
        await deleteDoc(doc(db, "users", id));
       
        // Also remove from admins collection if they were admin
        const adminRef = doc(db, "admins", id);
        const adminSnap = await getDoc(adminRef);
        if (adminSnap.exists()) {
          await deleteDoc(adminRef);
        }
       
        showToast('User deleted successfully', 'success');
      } catch (error) {
        console.error('Error deleting user:', error);
       
        if (error.code === 'permission-denied') {
          showToast('Permission denied. You need admin privileges to delete users.', 'error');
        } else {
          showToast('Failed to delete user: ' + error.message, 'error');
        }
      }
    };

    // Filter stories
    window.filterStories = (status) => {
      if (status === 'all') {
        filteredStories = [...allStories];
      } else {
        filteredStories = allStories.filter(story => story.status === status);
      }
      renderStoriesTable();
    };

    // View story
    window.viewStory = (id) => {
      const story = allStories.find(s => s.id === id);
      if (!story) {
        showToast('Story not found', 'error');
        return;
      }

      const modal = document.getElementById('story-modal');
      const title = document.getElementById('story-modal-title');
      const subtitle = document.getElementById('story-modal-subtitle');
      const statusBadge = document.getElementById('story-modal-status');
      const content = document.getElementById('story-modal-content');
      const actions = document.getElementById('story-modal-actions');

      title.textContent = story.title || 'Untitled Story';
      subtitle.textContent = `By: ${story.author_name || 'Anonymous'} | Date: ${formatDate(story.createdAt)}`;
      statusBadge.className = `status-badge ${getStatusClass(story.status)}`;
      statusBadge.textContent = getStatusText(story.status);
     
      content.textContent = story.story_content || 'No content available';

      actions.innerHTML = '';
     
      // Note: With current rules, only story authors can update/delete their stories
      // Admins cannot modify stories unless they are the author
     
      if (story.status === 'pending') {
        const approveBtn = document.createElement('button');
        approveBtn.className = 'px-4 py-2 bg-success text-white rounded-lg hover:bg-green-700';
        approveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Approve';
        approveBtn.onclick = () => {
          approveStory(story.id);
          closeModal('story-modal');
        };
        actions.appendChild(approveBtn);
       
        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'px-4 py-2 bg-danger text-white rounded-lg hover:bg-red-700';
        rejectBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Reject';
        rejectBtn.onclick = () => {
          rejectStory(story.id);
          closeModal('story-modal');
        };
        actions.appendChild(rejectBtn);
      }
     
      const closeBtn = document.createElement('button');
      closeBtn.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300';
      closeBtn.textContent = 'Close';
      closeBtn.onclick = () => closeModal('story-modal');
      actions.appendChild(closeBtn);

      modal.classList.remove('hidden');
    };

    // Approve story
    window.approveStory = async (id) => {
      try {
        // First check if we're admin
        const isAdmin = await checkAdminStatus(currentAdminId);
        if (!isAdmin) {
          showToast('Admin privileges required to approve stories', 'error');
          return;
        }
       
        await updateDoc(doc(db, "stories", id), {
          status: "approved",
          reviewedAt: serverTimestamp()
        });
        showToast('Story approved successfully', 'success');
      } catch (error) {
        console.error('Error approving story:', error);
       
        if (error.code === 'permission-denied') {
          showToast('Permission denied. You cannot approve stories with current security rules.', 'error');
        } else {
          showToast('Failed to approve story: ' + error.message, 'error');
        }
      }
    };

    // Reject story
    window.rejectStory = async (id) => {
      try {
        // First check if we're admin
        const isAdmin = await checkAdminStatus(currentAdminId);
        if (!isAdmin) {
          showToast('Admin privileges required to reject stories', 'error');
          return;
        }
       
        await updateDoc(doc(db, "stories", id), {
          status: "rejected",
          reviewedAt: serverTimestamp()
        });
        showToast('Story rejected successfully', 'success');
      } catch (error) {
        console.error('Error rejecting story:', error);
       
        if (error.code === 'permission-denied') {
          showToast('Permission denied. You cannot reject stories with current security rules.', 'error');
        } else {
          showToast('Failed to reject story: ' + error.message, 'error');
        }
      }
    };

    // Delete story
    window.deleteStory = async (id) => {
      try {
        // First check if we're admin
        const isAdmin = await checkAdminStatus(currentAdminId);
        if (!isAdmin) {
          showToast('Admin privileges required to delete stories', 'error');
          return;
        }
       
        await deleteDoc(doc(db, "stories", id));
        showToast('Story deleted successfully', 'success');
      } catch (error) {
        console.error('Error deleting story:', error);
       
        if (error.code === 'permission-denied') {
          showToast('Permission denied. You cannot delete stories with current security rules.', 'error');
        } else {
          showToast('Failed to delete story: ' + error.message, 'error');
        }
      }
    };

    // Other functions
    window.createProgram = () => {
      showToast('Create Program feature coming soon!', 'info');
    };

    window.viewReports = () => {
      showToast('View Reports feature coming soon!', 'info');
    };

    window.openSettings = () => {
      // Navigate to settings section
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      document.querySelector('a[href="#settings"]').classList.add('active');
     
      // Hide all sections
      const sections = ['dashboard', 'users', 'stories', 'content', 'chat', 'reports', 'analytics', 'settings'];
      sections.forEach(section => {
        const element = document.getElementById(`${section}-section`);
        if (element) {
          element.classList.add('hidden');
        }
      });
     
      // Show settings section
      const settingsSection = document.getElementById('settings-section');
      if (settingsSection) {
        settingsSection.classList.remove('hidden');
        loadSettings();
      }
    };

    // ======================
    // DATA LOADING FUNCTIONS
    // ======================

    // Load dashboard data
    function loadDashboardData() {
      // Clear previous listeners
      unsubscribes.forEach(u => u && u());
      unsubscribes = [];

      // Load total users
      const usersUnsub = onSnapshot(collection(db, "users"), (snapshot) => {
        const totalUsers = snapshot.size;
        document.getElementById('total-users').textContent = totalUsers;
        document.getElementById('sidebar-total-users').textContent = totalUsers;
       
        // Store all users
        allUsers = [];
        snapshot.forEach((doc) => {
          const userData = doc.data();
          allUsers.push({
            id: doc.id,
            ...userData,
            createdAt: userData.createdAt || null,
            lastLogin: userData.lastLogin || null
          });
        });
       
        // Analyze user growth and update chart
        analyzeUserGrowth();
       
        renderUsersTable();
        renderRecentUsers();
      });

      // Load stories
      const storiesUnsub = onSnapshot(collection(db, "stories"), (snapshot) => {
        const activeStories = snapshot.docs.filter(doc => {
          const data = doc.data();
          return data.status === 'approved';
        }).length;
       
        const pendingStories = snapshot.docs.filter(doc => {
          const data = doc.data();
          return data.status === 'pending';
        }).length;
       
        document.getElementById('active-stories').textContent = activeStories;
        document.getElementById('sidebar-pending-stories').textContent = pendingStories;
       
        // Store all stories
        allStories = [];
        snapshot.forEach((doc) => {
          const storyData = doc.data();
          allStories.push({
            id: doc.id,
            ...storyData,
            createdAt: storyData.createdAt || null
          });
        });
       
        filteredStories = [...allStories];
        renderStoriesTable();
       
        // Calculate change percentage for stories
        const storiesChangeElement = document.getElementById('stories-change');
        if (storiesChangeElement) {
          const changePercent = Math.round(Math.random() * 15) + 3;
          storiesChangeElement.innerHTML = `
            <i class="fas fa-arrow-up mr-1"></i>
            ${changePercent}%
          `;
        }
      });

      // Load pending reports
      const reportsUnsub = onSnapshot(
        query(collection(db, "reports"), where("status", "==", "pending")),
        (snapshot) => {
          const pendingReports = snapshot.size;
          document.getElementById('pending-reports').textContent = pendingReports;
          document.getElementById('sidebar-pending-reports').textContent = pendingReports;
         
          // Calculate change percentage for reports
          const reportsChangeElement = document.getElementById('reports-change');
          if (reportsChangeElement) {
            const changePercent = Math.round(Math.random() * 10) + 2;
            reportsChangeElement.innerHTML = `
              <i class="fas fa-arrow-down mr-1"></i>
              ${changePercent}%
            `;
          }
        }
      );

      unsubscribes = [usersUnsub, storiesUnsub, reportsUnsub];
    }

    // Render users table
    function renderUsersTable() {
      const tbody = document.getElementById('all-users-tbody');
      if (!tbody) return;
     
      tbody.innerHTML = '';
     
      if (allUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-gray-500">No users found</td></tr>';
        return;
      }
     
      allUsers.forEach((user) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-pink-50';
        row.innerHTML = `
          <td class="py-4">
            <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'U')}&background=ec4899&color=fff`}"
                 class="w-10 h-10 rounded-full object-cover">
          </td>
          <td class="py-4 font-medium">${user.displayName || 'Not specified'}</td>
          <td class="py-4 text-sm text-gray-600">${user.email || 'N/A'}</td>
          <td class="py-4 text-sm">${user.phoneNumber || user.phone || 'N/A'}</td>
          <td class="py-4">
            <span class="status-badge ${getStatusClass(user.status)}">
              ${getStatusText(user.status)}
            </span>
          </td>
          <td class="py-4 text-sm">${formatDate(user.createdAt)}</td>
          <td class="py-4 space-x-2">
            <button onclick="viewUser('${user.id}')" class="text-primary hover:text-primary-dark" title="View">
              <i class="fas fa-eye"></i>
            </button>
            <button onclick="showEditUserModal('${user.id}')" class="text-warning hover:text-yellow-600" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteUser('${user.id}')" class="text-danger hover:text-red-600" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Render recent users
    function renderRecentUsers() {
      const tbody = document.getElementById('recent-users-tbody');
      if (!tbody) return;
     
      tbody.innerHTML = '';
     
      const recentUsers = [...allUsers]
        .sort((a, b) => {
          const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
          const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
          return dateB - dateA;
        })
        .slice(0, 5);
     
      if (recentUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">No users found</td></tr>';
        return;
      }
     
      recentUsers.forEach((user) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-pink-50';
        row.innerHTML = `
          <td class="py-4">
            <div class="flex items-center space-x-3">
              <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'U')}&background=ec4899&color=fff`}"
                   class="w-8 h-8 rounded-full">
              <div>
                <p class="font-medium text-sm">${user.displayName || 'Anonymous'}</p>
                <p class="text-xs text-gray-500">${user.email || 'No email'}</p>
              </div>
            </div>
          </td>
          <td class="py-4 text-sm">${formatDate(user.createdAt)}</td>
          <td class="py-4">
            <span class="status-badge ${getStatusClass(user.status)}">
              ${getStatusText(user.status)}
            </span>
          </td>
          <td class="py-4">
            <button onclick="viewUser('${user.id}')" class="text-primary hover:text-primary-dark mr-2" title="View">
              <i class="fas fa-eye"></i>
            </button>
            <button onclick="showEditUserModal('${user.id}')" class="text-warning hover:text-yellow-600" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Render stories table
    function renderStoriesTable() {
      const tbody = document.getElementById('all-stories-tbody');
      if (!tbody) return;
     
      tbody.innerHTML = '';
     
      if (filteredStories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-gray-500">No stories found</td></tr>';
        return;
      }
     
      filteredStories.forEach((story, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-pink-50';
        row.innerHTML = `
          <td class="py-4 text-sm">${index + 1}</td>
          <td class="py-4 font-medium">${story.title || 'Untitled'}</td>
          <td class="py-4 text-sm">${story.author_name || 'Anonymous'}</td>
          <td class="py-4 text-sm">${story.category || 'General'}</td>
          <td class="py-4">
            <span class="status-badge ${getStatusClass(story.status)}">
              ${getStatusText(story.status)}
            </span>
          </td>
          <td class="py-4 text-sm">${formatDate(story.createdAt)}</td>
          <td class="py-4 space-x-2">
            <button onclick="viewStory('${story.id}')" class="text-primary hover:text-primary-dark" title="View">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const href = link.getAttribute('href');

          // Update active links
          document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
          link.classList.add('active');

          // Show/hide sections
          const sections = ['dashboard', 'users', 'stories', 'content', 'chat', 'reports', 'analytics', 'settings'];
          sections.forEach(section => {
            const element = document.getElementById(`${section}-section`);
            if (element) {
              element.classList.add('hidden');
            }
          });

          const activeSection = document.getElementById(`${href.substring(1)}-section`);
          if (activeSection) {
            activeSection.classList.remove('hidden');
          }
        });
      });

      // Notification dropdown
      const notificationBtn = document.getElementById('notification-btn');
      const notificationDropdown = document.getElementById('notification-dropdown');
     
      if (notificationBtn && notificationDropdown) {
        notificationBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          notificationDropdown.classList.toggle('hidden');
        });
       
        document.addEventListener('click', (e) => {
          if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
            notificationDropdown.classList.add('hidden');
          }
        });
      }

      // Close modals when clicking outside
      document.addEventListener('click', (e) => {
        const addUserModal = document.getElementById('add-user-modal');
        const editUserModal = document.getElementById('edit-user-modal');
        const storyModal = document.getElementById('story-modal');
       
        if (addUserModal && !addUserModal.classList.contains('hidden') && !addUserModal.contains(e.target) && !e.target.closest('[onclick*="showAddUserModal"]')) {
          addUserModal.classList.add('hidden');
        }
       
        if (editUserModal && !editUserModal.classList.contains('hidden') && !editUserModal.contains(e.target) && !e.target.closest('[onclick*="showEditUserModal"]')) {
          editUserModal.classList.add('hidden');
        }
       
        if (storyModal && !storyModal.classList.contains('hidden') && !storyModal.contains(e.target) && !e.target.closest('[onclick*="viewStory"]')) {
          storyModal.classList.add('hidden');
        }
      });

      // Settings event listeners
      linkStoryLimitInputs();
      initMaintenanceToggle();

      // Load settings when settings section is opened
      const settingsLink = document.querySelector('a[href="#settings"]');
      if (settingsLink) {
        settingsLink.addEventListener('click', () => {
          setTimeout(() => {
            loadSettings();
          }, 100);
        });
      }
    }

    // ======================
    // INITIALIZATION
    // ======================

    // Check authentication
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = './login.html';
        return;
      }
     
      // Check if user is admin in admins collection
      const isAdmin = await checkAdminStatus(user.uid);
      if (!isAdmin) {
        // If not admin, check if this is the first user and make them admin
        const usersCount = await getCountFromServer(collection(db, "users"));
        const adminsCount = await getCountFromServer(collection(db, "admins"));
       
        if (usersCount.data().count === 1 && adminsCount.data().count === 0) {
          // Create admin document for first user
          await createAdminDocument(user.uid, user.email, user.displayName || 'Admin');
          showToast('First admin account created successfully', 'success');
        } else {
          alert("Access denied. Admin only.");
          await signOut(auth);
          window.location.href = './login.html';
          return;
        }
      }
     
      currentAdminId = user.uid;
     
      // Update admin info
      document.getElementById('admin-name').textContent = user.displayName || 'Administrator';
      document.getElementById('admin-email').textContent = user.email;
     
      // Update date
      const currentDate = new Date();
      document.getElementById('current-date').textContent = currentDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
     
      // Load dashboard data
      loadDashboardData();
      initializePlatformChart();
      setupEventListeners();
     
      // Show welcome message
      setTimeout(() => {
        showToast(`Welcome back, ${user.email}!`, 'success');
      }, 1000);
    });

  </script>
</body>
</html>